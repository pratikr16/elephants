---
  editor_options:
    chunk_output_type: console
  chunk_output_type: console
---
# Temp fates of incoming eles

# Load libs

```{r load_libs, message=FALSE, warning=FALSE}
#set env
library(plyr);library(dplyr);library(purrr);library(purrrlyr);library(data.table);library(lubridate);library(tidyr)

library(ggplot2)
```

```{r ggplot_theme}
g1 = theme(panel.grid = element_blank(), legend.position="none")
unit = unit(0, "cm")
```

```{r get_data}
source("ele.code002.5dataloading.r")
```


# Split and arrange, get waterdiff and tempdiff

```{r temp_change}
library(zoo)
#'rate of tempchange as a relation to distance to water of points

ele02 = ele %>% dlply("id") %>%
  map(function(x) plyr::arrange(x, time) %>% mutate(tempdiff = c(NA, diff(temp, lag = 1)), waterdiff = c(diff(distw, lag = 1), NA))) %>% bind_rows()
```

# Filter data
Filter data to include only:
1. Incoming eles, waterdiff > -500:+500
2. Distwater <= 500
3. All points satisfying both above, and the next 10 points.

```{r temp_fates_data}
#'work on the split ele02 as etf1, ie, ele temp fates 1

#'split into list of 13
etf1 = ele02 %>% dlply("id") %>% map(function(x) mutate(x, arrival = ifelse(waterdiff < 0 & distw <=500, "arrival", "other")))

#'split each df into a list by the arrival event
etf2 = etf1 %>% map(function(x) x %>% dlply("arrival"))

#'find the timediff in the arrival events df
for(i in 1:13){
  x = etf2[[i]]$arrival
  etf2[[i]]$arrival$timediff = c(NA, difftime(x$time[-1], x$time[-dim(x)[1]], units = "hours"))
  etf2[[i]]$arrival = etf2[[i]]$arrival %>% filter(timediff > 5)
}

#'bind rows
etf3 = etf2 %>% map(rbind_list) %>% map(function(x) arrange(x, time))
```

```{r id_consecutive_points}
#'find the next 10 points at each arrival event
for(i in 1:13){
  a = which(etf3[[i]]$arrival == "arrival")
  etf3[[i]] = etf3[[i]][unique(sort(a + rep(0:10, each = length(a)))),]
  etf3[[i]] = etf3[[i]] %>% filter(distw < 500)
}

etf3 = etf3 %>% map(function(x) x = x %>% mutate(event = cumsum(arrival == "arrival")))
```

