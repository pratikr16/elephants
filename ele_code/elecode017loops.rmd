---
output: html_document
editor_options:
  chunk_output_type: console
---

# identifying loops

```{r}
source("libs.R");library(sp)
source("ggplot.pub.r")
```

```{r}
#'load data
load("eledata.rdata")
ele.data <- ele %>%
  bind_cols(data.frame(sf::st_coordinates(.))) %>%
  sf::`st_geometry<-`(NULL) %>% unclass() %>% as.data.frame() %>%
  #filter(temp %in% 14:40) %>%
  dplyr::select(id, season2, xutm = coords.x1, yutm = coords.x2, time, v, hour, mindw, distance, calc.speed, temp, long, lat, angle) %>%
  mutate(timenum = as.numeric(time)) %>%
  group_by(id) %>%
  mutate(waterdiff = c(NA, diff(mindw)))

#'frontiers figure sizes in inches
full = 180/25.4; half = 85/25.4
```

# find high rev and low distance to water

```{r}
#'is the ele within 200m of water? why 200m? it is the mean ele steplength ~199.24
ele.data$watervisits <- ifelse(ele.data$mindw <= 200, 1, 0)
#a = ele.data %>% filter(watervisits == 1, !is.na(waterdiff)) %>% select(id, xutm, yutm, v, angle, mindw, revisits, residence, fpt, waterdiff)

#write.csv(a, file = "ele.watervisits.csv", row.names = F)
```

# find water visits by each ele

```{r}
#'separate by ele, and find the time between consecutive watervisits

ele.waterpoints <- ele.data %>%
  filter(watervisits == 1) %>%
  #select(-watervisits) %>%
  split("id") %>%
  map(function(x){
    x %>% mutate(wvint = c(NA, diff(timenum))/3600)
  }) %>%
  bind_rows() %>%
  na.omit()
```
``

# Distance between track start and end AND how many points of raw data are in segments of different classes?

```{r}
#'split by id, arrange by time, identify a change from water visit to non-watervisit points, where there's a positive change, ie, status shifts from non-watervisit to watervisit, classify as arrival, where a negative change, classify as departure, where no change but point is within 200m of water, classify as at water, all others where no change classify as segment points

ele.data <- ele.data %>%
  left_join(ele.waterpoints) %>%
  dlply("id") %>%
  map(function(x){
    x %>%
      arrange(timenum) %>%
      mutate(ss = c(NA, diff(watervisits))) %>%
  filter(!is.na(ss)) %>%
  mutate(behav = case_when(ss == 1 ~ "arrival", ss == -1 ~ "departure", ss == 0 & watervisits == 1 ~ "at water", ss == 0 ~ "segment", T~ as.character(NA)))
  })

#'get continuous residence points
ele.watertime <- ele.data %>%
  map(function(x){
    x %>%
      arrange(timenum) %>%
      filter(behav %in% c("at water","arrival")) %>%
      mutate(watertime = cumsum(behav == "arrival"))
  }) %>%
  bind_rows()

#watertime of each ele
ele.watertime %>% ungroup() %>% group_by(id) %>% summarise(n = max(watertime)) %>% .$n %>% sum()

#'arrange by time, remove at water poitns, and assign segment id (loop) as cumulative sum of departures. segments now begin at departures and end at arrival
ele.data <- ele.data %>%
  map(function(x){
    x %>%
      arrange(timenum) %>%
      filter(behav != "at water") %>%
      mutate(loop = cumsum(behav == "departure"))
  }) %>%
  bind_rows()
```

## identifying and numbering segments between water

```{r}
#'for each elephant and each segment, find
#'1. the segemnt duration in hours
#'2. the segment time in hours
#'3. the segment proportion in time
ele.data <- ele.data %>%
  dlply(c("id", "loop")) %>%
  map(function(x){
    x %>%
      mutate(loopdur = (last(timenum) - first(timenum))/3600,
         looptime = (timenum - first(timenum))/3600,
         loopprop = looptime/loopdur)
  })

for (i in 1:length(ele.data)) {
  a = ele.data[[i]]
  c = spDists(cbind(a$xutm, a$yutm), cbind(a$xutm[1], a$yutm[1]))
  ele.data[[i]]$nsd = c
}

ele.data <- bind_rows(ele.data)
```

```{r temp_at_water}
#'eles at water, temp by hour
fig_temp_at_water_hour <- ggplot()+
  geom_tufteboxplot(data = ele.waterpoints, aes(x = (hour), y = temp, group = interaction(season2, hour),col = season2), median.type = "line", whisker.type = "point")+
  
  scale_colour_brewer(palette = "Set1")+
  
  scale_x_continuous(breaks = c(0, 6, 12, 18, 22))+
  scale_y_continuous(breaks = seq(10, 45, 5))+
  coord_cartesian(xlim=c(0,23), y = c(10,45), expand = T)+
  geom_rangeframe(data=data_frame(x = c(0,22), y=c(10,45)), aes(x,y))+
  theme_pub()+
  labs(list(x = "Hour of day", y = "Thermochron temp. at water (°C)"))


ggsave(filename = "fig_temp_at_water_hour.png", fig_temp_at_water_hour, height = half, width = half, device = png());dev.off()

```


```{r}
quantile(ele.data$loopdur, na.rm = T, 0.90)
#'diagnostic plot
z4 %>%
  ggplot()+
  stat_density(aes(x = loopdur, col = season2),geom = "line", position = "identity")+
  scale_color_brewer(palette = "Set1")+
  theme_pub()+
  scale_y_continuous(sec.axis = sec_axis(trans = ~.*nrow(ele.data), name = "number of points"))+
  labs(list(x = "segment duration (hrs)", y = "proportion of points"))+
  xlim(0,120)
```

```{r}
ele.data <- ele.data %>%
  ungroup() %>%
  mutate(class = cut(loopdur, breaks = c(-Inf,3,12,24,48, Inf)))
```


```{r }
#'now find the displacement between the first and last point
library(sp)

#'get the first and last x-y coords, the season, the time taken for the loop to be completed, the mean speed, the temperature at the halfway point, the mean temperature along the loop, the instantaneous change in temp at the halfway stage
ele.segment.summary <- z3 %>% bind_rows() %>% group_by(id, loop) %>% arrange(id, loop, time) %>%
  summarise(points = length(xutm),
            x1 = first(xutm),
            y1 = first(yutm),
            x2 = last(xutm),
            y2 = last(yutm),
            x50 = long[min(which(round_any(loopprop, 0.05) == 0.5))],
            y50 = lat[min(which(round_any(loopprop, 0.05) == 0.5))],
            long_start = first(long),
            lat_start = first(lat),
            long_end = last(long),
            lat_end = last(lat),
            season = first(season2),
            looptime = max(looptime, na.rm = T),
            v = mean(v, na.rm = T),
            t50 = temp[min(which(round_any(loopprop, 0.05) == 0.5))],
            temp_mean = mean(temp, na.rm=T),
            temp_start = first(temp),
            temp_end = last(temp),
            wvint = first(wvint),
            distance = sum(distance, na.rm=T),
            maxdw = max(mindw,na.rm = T),
            hour_start = first(hour),
            hour_50 = hour[min(which(round_any(loopprop, 0.05) == 0.5))],
            hour_end = last(hour),
            mdw_start = first(mindw),
            mdw_end = last(mindw),

            time50 = time[min(which(round_any(loopprop, 0.05) == 0.5))],
            time_start = first(time),
            time_end = last(time))
```

```{r}
#'remove initial segment and all segments with less than 2 points.
ele.all.segments <- ele.segment.summary %>%
  filter(loop > 0, points > 2) %>%
  ungroup() %>%
  mutate(class = cut(looptime, breaks = c(-Inf,3,12,24,48, Inf))) %>%
  filter(!is.na(class))

##diagnostic plot
#ele.all.segments <-
ele.all.segments %>%
  ggplot(aes(x = class, fill = season, y = ..count../sum(..count..)))+
  geom_bar()+
  #scale_fill_solarized(accent = "orange")+
  #scale_fill_manual(values = solarized_pal()(9)[c(2,1)])
  scale_y_continuous(sec.axis = sec_axis(trans = ~.*nrow(ele.all.segments), name = "number of segments"))+
  labs(list(x = "segment duration (hrs)", y= "proportion of segments"))

#'split by each loop
ele.all.segments <- ele.all.segments %>% dlply(c("id","loop"))

library(geosphere)
#'now find distances between first and last points of the loop
for(i in 1:length(ele.all.segments)){
  a <- ele.all.segments[[i]]
  b <- distVincentyEllipsoid(cbind(a$long_start, a$lat_start), cbind(a$long_end, a$lat_end))
  ele.all.segments[[i]]$displace <- b
}

ele.all.segments <- ele.all.segments %>% rbind_list()
#'median segments
#ele.median.segments <- ele.all.segments %>% filter(looptime <= 48)
```

```{r}
#'count shuttling
ele.all.segments %>% ungroup() %>% count(displace <= 500)
#'count shuttling
ele.all.segments %>% ungroup() %>% count(displace <= 1000)
```

## histogram of durations

**this is the only plot looking at all segments**

```{r}
fig_segment_distr <-
  ggplot()+
  stat_density(data = ele.segment.summary, aes(x = looptime, col = season, fill = season, lty = season, y = ..density../10),geom = "line", position = "identity")+
  
scale_y_continuous(breaks = c(0, .15, .3))+
 # geom_rect(aes(xmin = 12, xmax = 24, ymin = 100, ymax = 4500), fill = "transparent", col = 1, lwd = 0.3)+
  
  geom_rangeframe(data = data_frame(x = c(10,100), y=c(0,0.3)), aes(x,y))+

  labs(list(x = "Segment duration (hours)", y= "% Segments", title = "(a)"))+
  scale_colour_brewer(palette = "Set1")+
  scale_linetype_manual(values = c(2,1))+
  theme_pub()+scale_x_log10(breaks = c(10,30,60,100))

```

## how far are midpoints from each other?

```{r}
#normal segments
#ele.median.segments <- ele.all.segments %>% filter(looptime <= 48)

#'find the distance between 1st midpoint and all other midpoints
#'first filter nas
ele.day.segments <- ele.median.segments %>% filter(class == "(12,24]")

library(geosphere)
ele_p50_dists = ele.day.segments %>%
  dlply("id") %>%
  map(function(x){data_frame(
   p50dist =  c(NA, distVincentyEllipsoid(p1 = x[c("x50","y50")]#,
                                 # p2 = x[-1,c("x50","y50")]
                                )),
   loop = x$loop,
   id = x$id,
   season = x$season)
  }) %>% bind_rows()

```

**ALL FURTHER PLOTS SHOW ONLY 12 - 24 HOUR SEGMENTS**

## plots of midpoint distance

```{r}
#fig_segment_mid_distr <-
  ele_p50_dists %>% filter(p50dist/1e3 <=10) %>% 
    ggplot()+
  
  geom_rangeframe(data = data_frame(x=c(0,10),y=c(00,150)), aes(x,y))+
  
  stat_density(aes(x = p50dist/1e3, y = ..count.., lty = season, col = season), position = "identity", geom = "line")+
 scale_colour_brewer(palette = "Set1")+
 
  scale_x_continuous(breaks = seq(0,10,5))+
  scale_y_continuous(breaks = seq(0,150,150))+
  scale_linetype_manual(values = c(2,1))+
  theme_pub()+
  coord_cartesian(xlim = c(0,10))+
  labs(list(x = "Displacement segment midpoints (km)", y = "Segments", title = "(d)"))

```

## distance along segment

```{r}
fig_segment_dist_distr <-
ggplot()+
  stat_density(data = ele.all.segments, aes(x = distance/1e3, y = ..density../10, lty = season, col = season), position = "identity",lwd = 0.5, geom = "line")+
  
geom_rangeframe(data = data_frame(x=c(0,25),y=c(0,0.010)), aes(x,y))+
  
  scale_colour_brewer(palette = "Set1")+
  #scale_fill_manual(values = c(1, "transparent"))+
  #facet_wrap(~ifelse(season2 == "dry", "Cool dry", "Hot wet"))+
  scale_linetype_manual(values = c(2,1))+
  scale_x_continuous(breaks = seq(0,25,5))+
  scale_y_continuous(breaks = c(0,0.01))+
  theme_pub()+
  coord_cartesian(xlim = c(0,25))+
  labs(list(x = "Segment distance (km)", y = "% Segments", title = "(b)"))
```


## displacement density plot

```{r ele_looping}
fig_segment_disp_distr <-
ggplot(ele.all.segments)+
  stat_density(aes(x = displace/1e3, y = ..density../10, lty = season, col = season), position = "identity", geom = "line")+
  
  geom_rangeframe(data = data_frame(x=c(0,10),y=c(0,.02)), aes(x,y))+
  scale_color_brewer(palette = "Set1")+
  scale_linetype_manual(values = c(2,1))+
  #xlim(0,10)+
  
  scale_x_continuous(breaks=seq(0,10,5))+
  scale_y_continuous(breaks=c(0,.01,.02))+
  
  theme_pub()+
  labs(list(x = "Segment displacement (km)", y = "% Segments", title = "(c)"))+
  coord_cartesian(xlim=c(0,10), expand = T)

```

## distance and displacement

```{r}
pdf(file = "figs/fig_distance_displacement.pdf", width = half, height = half)

dist.disp <- ele.all.segments %>%
  #filter(displace/distance <= 1) %>% 
  group_by(mdist = round_any(distance, 500), season) %>%
  summarise(mdisp = mean(displace, na.rm = T), sd = sd(displace, na.rm = T), n = length(displace)) %>%
  mutate(ci = qnorm(0.975)*sd/sqrt(n))

fig.distance_displacement <- ggplot()+
  geom_rangeframe(data = data_frame(x=c(0,10), y=c(0,5)), aes(x,y))+
  
  geom_segment(aes(x = 0,xend = 10,y=0,yend=10), size = 0.3)+

  #geom_smooth(data = ele.day.segments,  aes(x = distance/1e3, y = displace/1e3, lty = season, col = season, fill = season), method = "glm", lwd = 0.5, alpha = 0.2)+

  geom_pointrange(data = dist.disp, aes(x = mdist/1e3, y = mdisp/1e3, group = season, ymin = (mdisp-ci)/1e3,ymax = (mdisp+ci)/1e3, shape = season, col = season), fill = "white", position = position_dodge(width = 0.8), size = 0.2)+
  

# facet_wrap(~dur, scales = "free")+
  scale_shape_manual(values = c(21,24))+
  scale_linetype_manual(values = c(2,1))+
  scale_colour_brewer(palette = "Set1")+
  scale_fill_brewer(palette = "Set1")+
  
  scale_x_continuous(breaks=seq(0,10,5))+
  
  scale_y_continuous(breaks=c(0,2.5,5))+
  
  labs(list(x = "Segment distance (km)", y = "Segment displacement (km)"))+
  theme_pub()+
  #xlim(0,10)+ ylim(0,5)+
  #xlim(1.25,10)+ #ylim(0,5)#+
  coord_cartesian(xlim = c(0,10), ylim = c(0,5), expand = T)

dev.off()
```

## export fig 8 colour

```{r}
cairo_pdf(file = "figs/fig_segment_distributions.pdf", height = full, width = full)

library(gridExtra)

grid.arrange(fig_segment_distr, fig_segment_dist_distr, fig_segment_disp_distr, fig.distance_displacement, ncol = 2)

dev.off()
```

```{r}
#'now get only the loop and id data associated with these loops from ele6, which is all points

dayloopdata <- ele.all.segments %>% dplyr::select(id, loop) %>% left_join(ele.data, by = c("id", "loop")) %>%
  mutate(v = v/1e3, mindw = mindw/1e3)
```

## whats's happening in loops?

```{r}
#'loop data summary
dayloopdata <- dayloopdata %>%
  dplyr::select(loopprop, mindw, waterdiff, temp, loop, season2, v, hour)
```

## prep data for ci plots

```{r}
dayloopsum <- dayloopdata %>%
  mutate(v2 = v*2)
  group_by(season2, loopprop = round_any(loopprop, 0.1)) %>%
  dplyr::select(loopprop, season2, mindw, temp, v) %>%
  melt(id.vars = c("loopprop","season2")) %>%
  group_by(loopprop, season2, variable) %>%
  summarise(mean = mean(value, na.rm = T), sd = sd(value, na.rm = T), n = length(value)) %>%
  mutate(ci = qnorm(0.975)*sd/sqrt(n))
```

### plot all vars at once

```{r}

#fig8 <-
a = dayloopsum %>%
  select(loopprop, season2, mindw, temp, v2) %>% 
  gather(variable, value, -loopprop, -season2) %>% 
  group_by(stage = round_any(loopprop, 0.1), season2, variable) %>% 
  summarise_at(vars(value), funs(mean, sd, length)) %>% 
  mutate(ci = 1.96*sd/sqrt(length), variable = as.factor(case_when(
    variable=="mindw"~"Distance to water (km)",
    variable == "temp"~ "Thermochron temperature (°C)",
    variable == "v2"~"Speed (km/h)")))
  
#'reorder factor levels
#a$var2 = factor(a$var2, levels(a$var2)[c(3,1,3,2)])
#'plot all
```

```{r}
#fig8 list
fig8list = list()
for (i in 1:3){
  b <- a %>% filter(variable == levels(variable)[i])
  breaks <- c(first(pretty(c(min(b$mean), max(b$mean)))), last(pretty(c(min(b$mean), max(b$mean)))))
  
fig8list[[i]] <- ggplot(b)+

  geom_point(aes(x = stage, y = mean, col =season2, group = interaction(variable, season2), shape = season2))+
  
  geom_ribbon(aes(x = stage, y = mean, ymin = mean-ci, ymax = mean+ci,shape = season2, fill = season2), size = 0.3, alpha = 0.2)+
  
  geom_rangeframe(data = data_frame(x=c(0,1), y = breaks), aes(x,y))+
  
  scale_shape_manual(values = c(21,24))+
  scale_colour_brewer(palette = "Set1")+
  scale_fill_brewer(palette = "Set1")+
  
  scale_y_continuous(breaks = c(breaks, breaks[1]+diff(breaks)/2))+
  
  scale_x_continuous(breaks = c(0,0.5,1), labels = c("Start", "Midpoint", "End"))+
 # scale_y_continuous()
  #facet_wrap(~var3, scales = "free_y", strip.position = "top")+
  theme_pub()+
  #theme(strip.placement = "outside", strip.text = element_text(face ="plain", size = 8))+
  labs(list(x = NULL, y = levels(a$variable)[i], title = paste("(",letters[i],")", sep = "")))

}
```

## export segment figures

```{r}
pdf(file = "figs/fig08_trackvars.pdf", height = half, width= full)

library(gridExtra)

grid.arrange(fig8list[[1]],fig8list[[2]],fig8list[[3]],ncol = 3)

dev.off()
```
