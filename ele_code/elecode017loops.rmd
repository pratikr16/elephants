
# identifying loops

```{r}
source("libs.R")
source("ggplot.pub.r")
```

```{r}
#'load data and filter out extreme points
load("eledata.rdata")
ele.data <- ele2 %>% filter(temp %in% 14:40) %>% 
  select(id, season2, xutm, yutm, time, v, hour, mindw, distance, calc.speed, temp, long, lat) %>% 
  mutate(timenum = as.numeric(time)) %>% 
  group_by(id) %>% 
  mutate(waterdiff = c(NA, diff(mindw)))
#ele.rev = left_join(ele.rev, ele2) %>% 
 # filter(temp %in% c(14:40))

#'frontiers figure sizes in inches
full = 180/25.4; half = 85/25.4

```

# find high rev and low distance to water

```{r}
#'is the ele within 500m of water?

ele.data$watervisits <- ifelse(ele.data$mindw <=500,# & ele.data$residence >=10 & ele.data$revisits >= 10, 
1, 0)

#a = ele.data %>% filter(watervisits == 1, !is.na(waterdiff)) %>% select(id, xutm, yutm, v, angle, mindw, revisits, residence, fpt, waterdiff)

#write.csv(a, file = "ele.watervisits.csv", row.names = F)
```

# find water visits by each ele

```{r}
#'separate by ele, and find the time between consecutive watervisits

ele.waterpoints <- ele.data %>% 
  filter(watervisits == 1) %>% 
  split("id") %>% 
  map(function(x){
    x %>% mutate(wvint = c(NA, diff(timenum))/3600)
  }) %>% 
  bind_rows()

```

## Prep interval distribution

```{r interval_distr}

#'plot to see dist of revisit rates
#fig2b = 
ggplot()+
  stat_density(data = ele.waterpoints %>% filter(wvint > 3, wvint < 72),aes(x = wvint, col = season2), position = "identity",geom = "line", lwd = 0.7)+
  geom_rect(aes(xmin = 12, xmax = 24, ymin = 0.0, ymax = 0.035), col = "grey20", lwd = 0.2, fill = "transparent")+
 scale_colour_manual(values = c(cola, colb))+
  #facet_wrap(~ifelse(season2 == "dry", "Cool dry", "Hot wet"))+
  theme_pub()+
  labs(list(x = "Water visit interval (hrs)", title = "(b)"))
```

# Distance between track start and end AND how many points of raw data are in segments of different classes?

```{r}
#'remove points where the water visit interval is less than 3, these are points where the elephant is loitering near water. these are water visit points

ele.data <- ele.data %>% 
  left_join(ele.waterpoints) %>%
  mutate(watervisits = ifelse(is.na(watervisits), 0, watervisits))

#'group by ele, arrange by time, and assign loop numbers
ele.data <- ele.data %>% 
  group_by(id) %>% 
  arrange(id, time) %>% 
  mutate(loop = cumsum(watervisits))
```

## identifying and numbering segments between water

```{r}
#'for each elephant and each segment, find
#'1. the time difference between the ith point of the segment and the start
#'2. the change in distance to water from the start point
#'3. the change in temperature since the start
#'4. the instantaneous change in temperature
#'5. the proportion of the segment completed at each point
ele.data <- ele.data %>%
  group_by(id, loop) %>% 
  arrange(id, time) %>% 
  mutate(loopdur = (last(timenum) - first(timenum))/3600,
         looptime = (timenum - timenum[1])/3600,
         ambtempdiff = c(NA, diff(temp))) %>%
  mutate(loopprop = looptime/max(looptime))
```

```{r }
#'now find the displacement between the first and last point
library(sp)

#'get the first and last x-y coords, the season, the time taken for the loop to be completed, the mean speed, the temperature at the halfway point, the mean temperature along the loop, the instantaneous change in temp at the halfway stage
ele.segment.summary <- ele.data %>% group_by(id, loop) %>% arrange(id, loop, time) %>% 
  summarise(x1 = first(xutm), 
            y1 = first(yutm), 
            x2 = last(xutm), 
            y2 = last(yutm),
            long2 = last(long),
            lat2 = last(lat),
            season = first(season2), 
            looptime = max(looptime, na.rm = T), 
            v = mean(v, na.rm = T), 
            t50 = temp[min(which(round_any(loopprop, 0.05) == 0.5))], 
            temp = mean(temp, na.rm=T),
            temp_start = first(temp),
            temp_end = last(temp),
            tdiff50 = ambtempdiff[min(which(round_any(loopprop, 0.05) == 0.5))], 
            wvint = first(wvint), 
            distance = sum(distance, na.rm=T), 
            maxdw = max(mindw,na.rm = T), 
            hour_start = first(hour), 
            hour_50 = hour[min(which(round_any(loopprop, 0.05) == 0.5))], hour_end = last(hour), 
            mdw_start = first(mindw), 
            mdw_end = last(mindw), 
            x50 = long[min(which(round_any(loopprop, 0.05) == 0.5))], 
            y50 = lat[min(which(round_any(loopprop, 0.05) == 0.5))],
            time50 = time[min(which(round_any(loopprop, 0.05) == 0.5))])
```

```{r}
ele.all.segments <- ele.segment.summary %>% 
  filter(loop > 0)

#'remove loops with a looptime above 72
ele.median.segments <- ele.segment.summary %>% 
  filter(looptime > 3, looptime <= 75)

#'split by each loop
ele.median.segments <- ele.median.segments %>% dlply(c("id","loop"))

#'now find distances between first and last points of the loop
for(i in 1:length(ele.median.segments)){
  a = ele.median.segments[[i]]
  ele.median.segments[[i]]$between_point_dist = (spDists(x = as.matrix(a[c("x1","y1")]), y = as.matrix(a[c("x2","y2")])))
}

ele.median.segments <- ele.median.segments %>% rbind_list()
```

## histogram of durations

**this is the only plot looking at all segments**

```{r}
#fig5a.col =
  ggplot()+
  stat_density(data = ele.median.segments, aes(x = looptime, y = ..density.., lty = season, col = season),lwd = 0.5, geom = "line", position = "identity")+
  geom_rect(aes(xmin = 12, xmax = 24, ymin = -0.001, ymax = 0.042), col = "grey20", lwd = 0.2, fill = "transparent")+
 #scale_colour_manual(values = c(colb3, colb3))+
  scale_linetype_manual(values = c(2,1))+
  scale_colour_manual(values = c(cola, colb))+
  #facet_wrap(~ifelse(season2 == "dry", "Cool dry", "Hot wet"))+
  theme_pub()+
  labs(list(x = "Segment duration (hours)", y = "Probability density"))

#dev.off()
```

## how far are midpoints from each other?

```{r}
#'find the distance between 1st midpoint and all other midpoints
#'first filter nas
ele.day.segments <- ele.median.segments %>% filter(looptime %between% c(12,24)) %>% arrange(id, time50) 

library(geosphere)
ele_p50_dists = ele.day.segments %>%
  dlply("id") %>% 
  map(function(x){data_frame(
   p50dist =  c(NA, distVincentyEllipsoid(p1 = x[c("x50","y50")]#, 
                                 # p2 = x[-1,c("x50","y50")]
                                )),
   p_end_dist = c(NA, distVincentyEllipsoid(p1 = x[c("long2","lat2")])),
   loop = x$loop,
   id = x$id,
   season = x$season)
  }) %>% bind_rows()

```

**ALL FURTHER PLOTS SHOW ONLY 12 - 24 HOUR SEGMENTS**

## plots of midpoint distance
  
```{r}
#fig5d.col = 
  ele_p50_dists %>% 
    ggplot()+
    stat_density(aes(x = p50dist/1e3, y = ..density.., lty = season, col = season), position = "identity", lwd = 0.5, geom = "line")+
 scale_colour_manual(values = c(cola, colb))+
 #scale_colour_manual(values = c(1,"transparent"))+
  scale_linetype_manual(values = c(2,1))+
  theme_pub()+
  xlim(0,10)+
  labs(list(x = "Displacement segment midpoints (km)", y = "Probability density"))

```

# Temperature at segment start and maxdw

```{r}
ele.median.segments %>% 
  group_by(temp_start = round(temp_start), season) %>% 
  summarise(mean = mean(distance), sd = sd(distance), n = length(distance)) %>% 
  mutate(ci = qnorm(0.975)*sd/sqrt(n)) %>% 
  ggplot()+
  geom_pointrange(aes(x = temp_start, y = mean, ymin = mean-ci, ymax = mean+ci, col = season), position = position_dodge(0.5))+ylab("Max distance from water along segment (m)")+ggtitle("Segment durations: > 3 -- < 75 hours")
  scale_color_stata()
```



## distance along segment

```{r}
fig5b.col = ggplot()+
  stat_density(data = ele7 %>% filter(looptime >12, looptime < 24), aes(x = distance/1e3, y = ..density.., lty = season, col = season), position = "identity",lwd = 0.5, geom = "line")+
  scale_colour_manual(values = c(cola, colb))+
  #scale_fill_manual(values = c(1, "transparent"))+
  #facet_wrap(~ifelse(season2 == "dry", "Cool dry", "Hot wet"))+
  scale_linetype_manual(values = c(2,1))+
  theme_pub()+
  labs(list(x = "Segment length (km)", y = "Probability density"))
```


## displacement density plot

```{r ele_looping}
fig5c.col = ggplot(ele7 %>% filter(looptime > 12, looptime < 24))+
  stat_density(aes(x = between_point_dist/1e3, y = ..density.., lty = season, col = season), position = "identity", geom = "line")+
  scale_colour_manual(values = c(cola, colb))+
  scale_linetype_manual(values = c(2,1))+
  theme_pub()+
  labs(list(x = "Displacement start & end (km)", y = "Probability density"))+
  xlim(0,10)

```

## export fig 5 colour

```{r}
pdf(file = "figs/fig06_segment_distributions.pdf", height = 180/25.4, width = 180/25.4)

library(gridExtra)

grid.arrange(fig5a.col,fig5b.col, fig5c.col, fig5d.col, ncol = 2)

dev.off()
```


## distance and displacement

```{r}
pdf(file = "figs/fig07_distance_displacement.pdf", width = half, height = half)

ele7 %>% filter(looptime> 12, looptime < 24) %>% 
  group_by(mdist = round_any(distance, 500), season) %>% 
  summarise(mdisp = mean(between_point_dist, na.rm = T), sd = sd(between_point_dist, na.rm = T), n = length(between_point_dist)) %>% 
  mutate(ci = qnorm(0.975)*sd/sqrt(n)) %>% 
  
  ggplot(aes(x = mdist/1e3, y = mdisp/1e3, group = season))+
  
  geom_smooth(data = ele7 %>% filter(looptime > 12, looptime < 24),  aes(x = distance/1e3, y = between_point_dist/1e3, lty = season, col = season, fill = season),  method = "glm", formula = y~x, family = "gaussian", lwd = 0.5)+
  
  geom_pointrange(aes(ymin = (mdisp-ci)/1e3,ymax = (mdisp+ci)/1e3, shape = season, col = season), fill = "white", position = position_dodge(width = 0.8))+
  
# facet_wrap(~dur, scales = "free")+
  theme_pub()+theme(strip.text = element_text(colour = 1))+
  scale_shape_manual(values = c(21,24))+
  scale_linetype_manual(values = c(2,1))+
  scale_colour_manual(values = c(cola,colb))+
  scale_fill_manual(values = c(cola1,colb1))+
  labs(list(x = "Distance along segment (km)", y = "Displacement segment start & end (km)"))+
  xlim(1.25,10)+ #ylim(0,5)+
  coord_cartesian(xlim = c(1.5,10), ylim = c(0,5), expand = T)

dev.off()
```


```{r}
#'get the day loops
dayloops = ele7 %>% filter(looptime > 12, looptime<24)

#'now get only the loop and id data associated with these loops from ele6, which is all points

dayloopdata = ele7 %>% filter(looptime > 12, looptime<24) %>% select(id, loop) %>% left_join(ele6, by = c("id", "loop"))
```


## whats's happening in loops?

```{r}
#'loop data summary
dayloopdata = dayloopdata %>%
  #bind_rows() %>%
  #filter(looptime < 24, looptime > 12) %>%
  select(loopprop, mindw, waterdiff, temp, fpt, loop, season2, v, tempchange, woody.density, hour, ambtempdiff)
```

# plots

### stage and time of day

```{r}
#'use viridis throughout? no, red blue is understood by more people
#'purple is cool dry,green is hot wet
library(viridis)
#fig loop1 time ~ prop
#figS4 =
  dayloopdata %>%
    group_by(season2, loopprop = as.factor(round_any(loopprop, 0.1))) %>%
    #summarise(meanhour = mean(hour)) %>%
  ggplot()+
    theme_pub()+

#  geom_smooth(aes(x = loopprop, y = hour, col = season2, fill = season2), lty = 1, se = T, lwd = 0.5)+
 # geom_violin(aes(x = loopprop, y = hour), fill = "grey90", col = "transparent", position = position_dodge(width = 0.95))+
    geom_boxplot(aes(x = loopprop, y = hour, fill = season2, col = season2), position = position_dodge(width = 0.95), lwd = 0.3, notch = F, outlier.size = 0.2, outlier.colour = 1, outlier.shape = 21)+
    
  scale_color_manual(values = c(cola, colb))+
  scale_fill_manual(values = c(cola2, colb2))+
  scale_x_discrete(breaks = seq(0,1,0.5), labels = c("Start", "50%", "End"))+
    labs(list(x = "Track stage", y = "Hour of day"))
```

## start, end, 50% plots

```{r}
seg_time = ele7 %>%  filter(looptime > 12, looptime<24) %>% 
  group_by(loop, season) %>% 
  melt(measure.vars =c("hour_50","hour_end","hour_start"))

seg_time$variable = revalue(seg_time$variable, replace = c("hour_50" = "Halfway", "hour_end" = "End", "hour_start" = "Start"))
seg_time$variable = factor(seg_time$variable, levels(seg_time$variable)[c(3,1,2)])
```

## segment stage and hour of day violin plot

```{r}
source("geom_flat_violin.r")
pdf(file="fig.seg_time.pdf", width = 5, height = 3)
ggplot()+
  geom_flat_violin(data = seg_time, aes(x = variable, y = value), col = "transparent", position = "identity",fill = "grey60", lwd = 0.5, draw_quantiles = c(0.5), scale = "width")+
  geom_boxplot(data = seg_time, aes(x = variable, y = value), width = 0.1)+
 # scale_fill_manual(values = c(cola3, colb3, 1))+
  labs(list(x = "Segment stage", y = "Hour of day"))+
  theme_pub()+
  coord_flip()

dev.off()

```


## prep data for ci plots

```{r}
dayloopsum = dayloopdata %>% 
  group_by(season2, loopprop = round_any(loopprop, 0.1)) %>% 
  select(loopprop, season2, mindw, temp, v, woody.density) %>% 
  melt(id.vars = c("loopprop","season2")) %>% 
  group_by(loopprop, season2, variable) %>% 
  summarise(mean = mean(value, na.rm = T), sd = sd(value, na.rm = T), n = length(value)) %>% 
  mutate(ci = qnorm(0.975)*sd/sqrt(n))
```

### plot all vars at once

```{r}
#'plot all
dayloopsum %>% filter(variable != "woody.density") %>% 

ggplot()+
  geom_pointrange(aes(x = loopprop, y = mean, ymin = mean-ci, ymax = mean+ci,  col = season2, shape = season2, fill = season2), lty = 1, lwd = 0.5, fatten = 5, stroke = 0.6, position = position_dodge(width = 0.1))+
  scale_color_manual(values = c(cola, colb))+
   scale_fill_manual(values = c(cola2, colb2))+
  scale_shape_manual(values = c(21,24))+
    labs(list(x = "Track stage", y = "Value"))+
  scale_x_continuous(breaks = seq(0,1,0.5), labels = c("Start", paste(50,"%", sep=""), "End"))+
  #facet_wrap(~variable, scales = "free")+
  theme_pub()
```

### Fig 2(c) Distance to water vs track stage

```{r mindw_loop}

fig_seg2.col = 
  dayloopsum %>% filter(variable ==  "temp") %>% 

ggplot()+
  geom_pointrange(aes(x = loopprop, y = mean, ymin = mean-ci, ymax = mean+ci, shape = season2, col = season2),  lty = 1, position = position_dodge(width = 0.1), fill = "white")+
    scale_color_manual(values = c(cola, colb))+
#   scale_fill_manual(values = c(cola2, colb2))+
  scale_shape_manual(values = c(21,24))+
    labs(list(x = "Track stage", y = "Temperature (°C)"))+
  scale_x_continuous(breaks = seq(0,1,0.5), labels = c("Start", paste(50,"%", sep=""), "End"))+
  #facet_wrap(~variable, scales = "free")+
  theme_pub()


```

### Fig 2(e) Speed vs track stage

```{r}
fig_seg3.col = 
  dayloopsum %>% filter(variable ==  "v") %>% 

ggplot()+
  geom_pointrange(aes(x = loopprop, y = mean*2, ymin = (mean-ci)*2, ymax = (mean+ci)*2, shape = season2, col = season2), fill = "white", lty = 1, position = position_dodge(width = 0.1))+
  scale_color_manual(values = c(cola, colb))+
 #  scale_fill_manual(values = c(cola2, colb2))+
  scale_shape_manual(values = c(21,24))+
    labs(list(x = "Track stage", y = "Speed (m/hr)"))+
  scale_x_continuous(breaks = seq(0,1,0.5), labels = c("Start", paste(50,"%", sep=""), "End"))+
  scale_y_continuous(breaks = c(2e2,4e2,6e2,8e2))+
  theme_pub()
```

## mindw and stage

```{r}
fig_seg1.col = 
dayloopsum %>% filter(variable ==  "mindw") %>% 

ggplot()+
  geom_pointrange(aes(x = loopprop, y = mean, ymin = mean-ci, ymax = mean+ci, shape = season2, col = season2), fill = "white", position = position_dodge(width = 0.1))+
  scale_color_manual(values = c(cola, colb))+
#   scale_fill_manual(values = c(cola2, colb2))+
  scale_shape_manual(values = c(21,24))+
    labs(list(x = "Track stage", y = "Distance to water (m)"))+
  scale_x_continuous(breaks = seq(0,1,0.5), labels = c("Start", paste(50,"%", sep=""), "End"))+
  #facet_wrap(~variable, scales = "free")+
  theme_pub()
```

## export segment figures

```{r}
pdf(file = "figs/fig08_trackvars.pdf", height = half, width= full)
library(gridExtra)

grid.arrange(fig_seg1.col,fig_seg2.col,fig_seg3.col, nrow = 1)

dev.off()
```