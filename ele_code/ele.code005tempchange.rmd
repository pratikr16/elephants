---
  editor_options:
    chunk_output_type: console
  chunk_output_type: console
---

# Load libs

```{r load_libs, message=FALSE, warning=FALSE}
#set env
library(plyr);library(dplyr);library(purrr);library(purrrlyr);library(data.table);library(lubridate);library(tidyr)

library(ggplot2)
```

```{r load_data}
#'source script
source("ele.code002.5dataloading.r")
```

# Split and arrange

```{r temp_change}
library(zoo)
#'rate of tempchange as a relation to distance to water of points

ele02 = ele %>% dlply("id") %>%
  map(function(x) plyr::arrange(x, time) %>% mutate(tempdiff = c(NA, diff(temp, lag = 1)), waterdiff = c(diff(distw, lag = 1), NA))) %>% bind_rows()
```

```{r ggplot_theme}
g1 = theme(panel.grid = element_blank(), legend.position="none")
unit = unit(0, "cm")

```

# Delta distance to water ~ temp

```{r delta.distw_temp}

#png(filename = "fig6delta.distw_temp.png", res = 500, height = 1600, width = 1600)

cairo_pdf(file = "fig4delta.distw_temp.pdf", height = 4, width = 4)

ele02 %>% filter(abs(waterdiff) < 1000) %>%
  group_by(temp, season2) %>%
  summarise(mean.waterdiff = mean(waterdiff),
            sd.wd = sd(waterdiff), n.wd = length(waterdiff))  %>%
  mutate(wd.ci = qnorm(0.975)*sd.wd/sqrt(n.wd)) %>%
  ggplot()+

  geom_hline(aes(yintercept = 0), col = "grey20", lty = 2, lwd = 0.5)+

    geom_pointrange(aes(x = temp, y = mean.waterdiff, ymin = mean.waterdiff-wd.ci, ymax = mean.waterdiff+wd.ci, col = season2, shape = season2), position = position_dodge(width = 0.7), fatten = 10, lty = 1, fill = "white", stroke = 0.7, lwd = 0.2)+
  scale_colour_manual(values = c(cola,colb))+
  scale_shape_manual(values = c(21, 24))+

 # geom_label(x=20, y = 40, label = "Away from water", col = "grey50", hjust = "inward", vjust = "inward")+
 # geom_label(x=35, y = -40, label = "Towards water", col = "grey50", vjust = "inward")+

  theme_bw()+g1+
  labs(list(x = "Temperature (°C)", y = "Δ Distance to water (m)", fill = "Season", shape = "Season", colour = "Season"))+ylim(-25,30)+xlim(15,40)

dev.off()
```

# Source weather data

```{r source_weather_data}
#'load weather data
source("ele.code003.5weatherdata.r")
```


# Consecutive time at water

```{r cons_watertime}
#'check if ele within 100m of water, assign numerical indicator
#'split into dfs and
ele04 = ele02 %>%
  mutate(m100 = distw <=  1e3) %>%
  dlply("id", identity) %>%
  map(function(x) mutate(x, watertime = sequence(rle(as.character(x$m100))$lengths))) %>%
  bind_rows() %>%
  mutate(watertime = ifelse(m100 == F, 0, watertime))

#'merge weather data with ele04
#ele04 = left_join(ele04, tempdata[,c("temp.a","time")], by = "time")

#ele04$season = as.factor(ele04$season)
```

# Fig 1.C Heating curves

```{r heating_curve}
#png(filename = "deltatemp_hour.png", res = 300, width = 1600, height = 1600)
cairo_ps(file = "figx_heating_curve.eps", onefile = F, height = 4, width = 4)

ele04 %>% group_by(season2, hour) %>%
  summarise(mean.tempdiff = mean(tempdiff, na.rm = T), sd.tempdiff = sd(tempdiff, na.rm = T), n.tempdiff = length(tempdiff)) %>%
  mutate(td.ci = qnorm(0.975)*sd.tempdiff/sqrt(n.tempdiff)) %>%

  ggplot()+

  geom_hline(yintercept = 0, col = "grey50", lty = 2)+

  geom_pointrange(aes(x = hour, y = mean.tempdiff, ymin = mean.tempdiff-td.ci, ymax = mean.tempdiff+td.ci, col = season2, shape = season2), fatten = 5, position = position_dodge(width = 0.7))+


  scale_colour_manual(values = c("royalblue1", "indianred1"))+
  scale_shape_manual(values = c(16,17))+

    theme_bw()+g1+
  labs(list(x = "Hour of day", y = "Δ temperature (°C)"))

dev.off()
```
