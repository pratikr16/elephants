---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load libs
  
```{r load_libs, message=FALSE, warning=FALSE}
#set env
source("libs.R")
```

```{r load_data}
#'source script
load("eledata.rdata")
source('ggplot.pub.r')

#'no temp filtering
ele2 <- ele %>% as.data.frame()# %>% filter(temp %in% 14:40)
```

```{r load_tempdata}
#'load the skukuza flux tower temp data
tempdata = read.csv("~/git/elephants/ele_data/skukuza_tower_temp.csv")

#'handle time and convert to posixct date time
tempdata$time = as.POSIXct(paste(tempdata$dd.mm.yyyy, tempdata$hh.mm, sep = " "), tz = "SAST", format = "%d/%m/%Y %H:%M")
```

# Ele to tower

```{r ele_to_tower}
#'get tower loc
towerloc = tempdata[1,c("long","lat")]

#'load spatial libs
library(sp); library(rgdal); library(proj4); library(geosphere)

#'find dist from ele to tower
ele2$dist.tow = distVincentyEllipsoid(p1 = towerloc, p2 = ele2[,c("long","lat")])
```

# Eles within 10km

```{r eles_near_tower}
#'keep only eles within 10km of the tower

quantile(ele2$dist.tow, 0.01)

ele.tow = ele2 %>% filter(dist.tow <= 1e4)
```

```{r match_temp_ele.tow}
#'match half hourly temp to the eles
#'first round the ele time to the half hour
ele.tow = ele.tow %>% 
  mutate(roundtime = round_date(ele.tow$time, "30 minute"))

#'merge by time and round time
ele.tow = left_join(ele.tow, tempdata, by = c("roundtime" = "time"))
#'rename X.C
ele.tow = ele.tow %>% rename(temp.a = X.C)
tempdata = tempdata %>% rename(temp.a = X.C)

#'set all vals less than 0 to NA
ele.tow = ele.tow %>% mutate(temp.a = ifelse(temp.a < 0, NA, temp.a))
tempdata = tempdata %>% mutate(temp.a = ifelse(temp.a < 0, NA, temp.a))

#'add season to tempdata
tempdata = inner_join(tempdata, ele.tow[,c("roundtime","season2")], by = c("time" = "roundtime"))
```

# Plot temp_a and temp

```{r body_amb_temp_prep}
#'plot elephant body and ambient temp
ele.tow02 = ele2 %>% group_by(hour = hour(time),season2) %>% 
  summarise(meantemp = mean(temp), n = length(temp), sd = sd(temp)) %>% 
  mutate(t.ci = qnorm(0.975)*sd/sqrt(n))

towtemp = tempdata %>% group_by(hour = hour(time), season2) %>% 
  summarise(meantempa = mean(temp.a, na.rm= T), n.ta = length(temp.a), sd.ta = sd(temp.a, na.rm = T)) %>% 
  mutate(ta.ci = qnorm(0.975)*sd.ta/sqrt(n.ta))
```


```{r}
save(ele.tow, ele.tow02, towtemp, fig_temp_measure_hour, file = "/home/pratik/git/elephants/ele_data/ele.tower.rdata")
```


# Correlogram for hourly mean temps from eles ~ tower

```{r temp_matrix}
#'correlation between columns of x and y
#'set data and column names for eledata dry season

ele.tow03.dry = ele.tow %>% 
  filter(dist.tow <=1e4, season2 == "dry") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp) %>%  
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp, fill = NA) %>% 
  select(-ind)

#'set data for the wet season
ele.tow03.wet = ele.tow %>% 
  filter(dist.tow <=1e4, season2 == "wet") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp) %>%  
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp, fill = NA) %>% 
  select(-ind)

#'set colnames
colnames(ele.tow03.dry) = c(paste("ele", 1:24, sep="_"))
colnames(ele.tow03.wet) = c(paste("ele", 1:24, sep="_"))

#'set columns for the tower data for the dry season
towtemp03.dry = ele.tow %>% 
  filter(dist.tow<=1e4, season2 == "dry") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp.a) %>% 
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp.a, fill = NA) %>% 
  select(-ind)

#'for the wet season
towtemp03.wet = ele.tow %>% 
  filter(dist.tow<=1e4, season2 == "wet") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp.a) %>% 
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp.a, fill = NA) %>% 
  select(-ind)

#'set colnames
colnames(towtemp03.dry) = c(paste("amb", 1:24, sep="_"))
colnames(towtemp03.wet) = c(paste("amb", 1:24, sep="_"))
```

```{r corrs}
#'for each hour by col, store corr and p val as df per season
#'cool dry
corrs.dry = list()
#'do cor.test instead of cor
for(i in 1:24){
  corrs.dry[[i]] = (cor.test(x = as.data.frame(towtemp03.dry)[,i], y = as.data.frame(ele.tow03.dry)[,i]))[c("p.value","estimate")] %>% bind_cols()
}
#'get df with bound rows
corrs.dry = corrs.dry %>% bind_rows() %>% mutate(hour = 0:23, season = "cool")

#'for hot wet
corrs.wet = list()
#'do cor.test instead of cor
for(i in 1:24){
  corrs.wet[[i]] = (cor.test(x = as.data.frame(towtemp03.wet)[,i], y = as.data.frame(ele.tow03.wet)[,i]))[c("p.value","estimate")] %>% bind_cols()
}
#'get df with bound rows
corrs.wet = corrs.wet %>% bind_rows() %>% mutate(hour = 0:23, season = "hot")
```

## plot

```{r}
#'correlation by season by hour, filtered by p val

#pdf(file = "time.temp.corr.pdf", height = 5, width = 5)

bind_rows(corrs.dry, corrs.wet) %>%
  ggplot()+
  geom_point(aes(x = hour, y = estimate, shape = season, size = 1/p.value, fill = season))+
 # geom_path(aes(x = hour, y = estimate, shape = season), width = 0.2)+
  scale_shape_manual(values = c(21,24))+
  #scale_colour_manual(values = c(cola3, colb3))+
  labs(list(x = "Hour of day", y = "Temperature correlation (Pearson's r)"))

```


```{r custom_pval_matrix_func}
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
```

```{r}
#'LM for thermochron temperature ~ ambient temp
temp.model = lm(temp ~ temp.a + season2, data = ele.tow)

#'get model results
summary(temp.model)
```

# Plot hourly temp

```{r}

#### make figure of temps per hour of day
load("/home/pratik/git/elephants/ele_data/ele.tower.rdata")

fig_temp_measure_hour <- 
ggplot()+
    
    geom_rangeframe(data = data_frame(x = c(0,23), y=c(15,40)), aes(x,y))+
  
    geom_path(data = ele.tow02, aes(x = hour, y = meantemp, col = season2), lty = 1, position = position_dodge(width = 0.5), size = 0.6)+

  geom_path(data = towtemp, aes(x = hour, y = meantempa, col = season2), lty=2, position = position_dodge(width = 0.5), size = 0.7)+
  
  geom_ribbon(data = ele.tow02, aes(x = hour, ymin = meantemp-t.ci, ymax = meantemp+t.ci, group = season2, fill = season2), alpha = 0.2)+

  geom_ribbon(data = towtemp, aes(x = hour, ymin = meantempa-ta.ci, ymax = meantempa+ta.ci, group = season2, fill = season2), alpha = 0.2)+

  
  scale_colour_brewer(palette = "Set1")+
  scale_fill_brewer(palette = "Set1")+
  #scale_shape_manual(values = c(21,24))+
  coord_cartesian(xlim = c(0,23))+
  scale_x_continuous(breaks = c(0,4,8,12,16,20,23))+
  scale_y_continuous(breaks = seq(15,40,5))+
  theme_pub()+
  labs(list(x = "Hour of day", y = "Temperature (°C)", title = "(a)"))

```

# GLMM collar ~ ambient temp

```{r}
library(lme4)
mean_wo_na = function(x) mean(x, na.rm=T)
sd_wo_na = function(x) sd(x, na.rm = T)
mod.temp.measures = lmer(temp ~ temp.a + season2 + (1|id) + (1|hour), data = ele.tow)

summary(mod.temp.measures)
car::Anova(mod.temp.measures)

#'random effects model for within individual and hour std deviation
#'get the mean data
ele.BA.data = ele.tow %>% ungroup()%>% 
  #mutate(temp.a = log(temp.a), temp = log(temp)) %>% 
  group_by(hour) %>% 
  summarise_at(vars(temp.a, temp, mindw), funs(mean_wo_na, sd_wo_na)) %>% 
  mutate(ci = 1.96*temp_sd_wo_na/sqrt(24),
    #mean.measures = (temp.a+temp)/2, diff_measures = temp-temp.a,
         temp.a.diff = c(NA, diff(temp.a_mean_wo_na)))

mod.BA.data = lmer(temp ~ temp.a + season2 + (1|id) + (1|hour), data = ele.BA.data)
summary(mod.BA.data)
car::Anova(mod.BA.data)
#'get within indiv sd
sd.within.ele.within.hour = 4.3+0.9

#'BA plot with sd * 1.96 as limits of agreement

ele.BA.data = ele.BA.data %>% 
  ungroup() %>% 
  group_by(hour) %>% 
  summarise_at(vars(mean.measures, diff_measures), funs(mean_wo_na))

#figBA_revised = 
  ggplot()+
  
  #geom_rangeframe(data = data_frame(x = c(20,32.5), y = c(-5, 20)), aes(x,y))+
  #geom_hline(yintercept = c(mean(ele.BA.data$diff_measures, na.rm = T), 
                           # mean(ele.BA.data$diff_measures, na.rm = T) + 1.96*5.3,
                         #   mean(ele.BA.data$diff_measures, na.rm = T) - 1.96*5.2),
          #   col = c(colb, cola, cola), size = 1)+
    geom_errorbar(data = ele.BA.data, aes(x = temp.a_mean_wo_na, y = temp_mean_wo_na, ymin = temp_mean_wo_na - ci, ymax = temp_mean_wo_na+ci), col = 1)+
  
  geom_point(data = ele.BA.data, aes(x = temp.a_mean_wo_na, y = temp_mean_wo_na, fill = mindw_mean_wo_na, ymin = temp_mean_wo_na - ci, ymax = temp_mean_wo_na+ci), col = 1, shape = 21, size = 5)+
    
    
  geom_text(data = ele.BA.data, aes(x = temp.a_mean_wo_na -0.2, y = temp_mean_wo_na+0.5, label =hour), 
             size = 3, col = 1)+
  geom_point(data = ele.BA.data, aes(x = temp.a_mean_wo_na+0.2, y = temp_mean_wo_na-0.5), fill = ifelse(ele.BA.data$temp.a.diff > 0, "salmon", "forestgreen"),shape = ifelse(ele.BA.data$temp.a.diff > 0, 24, 25), size = 3, col = "transparent")+
  
  
  geom_abline(slope = 1, lty = 2, lwd = 0.3)+
  #scale_fill_gradientn(colours = c(viridis::magma(12), rev(viridis::viridis(12))))+
    scale_fill_gradientn(colours = rev(colorRampPalette(brewer.pal(9, "RdYlBu"))(24)))+
  #facet_wrap(~season2)+
  #labs(list(x = "Mean (collar & amb temp.) (°C)", y = "Collar temp. - ambient temp. (°C)", title = "(c)"))+
  #scale_x_continuous(breaks = seq(20,32.5, length.out = 6))+
  theme_bw()+
    labs(list(x = "ambient temp", y = "collar temp", fill = "distance\nto water"))

ggsave(filename = "plot_thermal_hysteresis_distwater_ele.png", device = png(), dpi = 300); dev.off()
```


# Scatterplot

```{r scatterplot}
#'plot scatterplot

#### to be replaced by a bland altman plot?


fig_temp_rel_data <- ele.tow %>% #filter(dist.tow <= 1e4) %>% 
  group_by(season2, temp.a = round(temp.a)) %>%
  summarise(mt = mean(temp, na.rm = T), sd.mt = sd(temp, na.rm = T), n.mt = length(temp)) %>% 
  mutate(mt.ci = qnorm(0.975)*sd.mt/sqrt(n.mt)) 
  
fig_temp_measure_relation <- 
ggplot()+
 # geom_smooth(aes(x = temp.a, y = mt, group = season2, lty = season2, col = season2), method = "glm", show_guide = F, lwd = 0.5,se =F, fill = "grey90")+
  geom_segment(aes(x = 5, xend = 40, y = 5, yend = 40),size = 0.3)+
  
  geom_pointrange(data = fig_temp_rel_data, aes(x = temp.a, y = mt, ymin = mt-mt.ci, ymax = mt+mt.ci,shape = season2,  col = season2), position = position_dodge(width = 0.5), lty = 1, fill = "white", size = 0.3)+
  
  
  geom_rangeframe(data = data_frame(x = c(5,40), y = c(4,44)), aes(x,y))+

  scale_colour_brewer(palette = "Set1")+
  scale_shape_manual(values = c(21, 24))+
  scale_x_continuous(breaks = seq(5,40,5))+
  scale_y_continuous(breaks = seq(4,44,4))+
  #scale_linetype_manual(values = c(2,1))+
  theme_pub()+
  coord_cartesian(xlim=c(5,40), ylim = c(5,44))+
  #coord_cartesian(xlim = c(0,40), ylim = c(0,40))+
  labs(list(x = "Ambient temperature (°C)", y = "Collar temperature (°C)", title = "(b)"))

#ggsave(filename = "fig01_b.png", fig01_b, device = png())
```

# Figure 3

```{r}
#'export fig for temp measures
library(gridExtra)

pdf(file = "figs/fig03temp_measures.pdf",height = half, width = full)
#png(filename = "fig_thermochron_data.png",height = 1600, width = 3200, res = 400)

grid.arrange(fig_temp_measure_hour, fig_temp_measure_relation, figBA_revised, nrow = 1)

dev.off()
```

