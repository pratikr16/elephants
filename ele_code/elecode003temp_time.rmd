---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load libs
  
```{r load_libs, message=FALSE, warning=FALSE}
#set env
source("libs.R")
```

```{r load_data}
#'source script
load("eledata.rdata")
source('ggplot.pub.r')

#'no temp filtering
ele2 <- ele %>% as.data.frame()# %>% filter(temp %in% 14:40)
```

```{r load_tempdata}
#'load the skukuza flux tower temp data
tempdata = read.csv("~/git/elephants/ele_data/skukuza_tower_temp.csv")

#'handle time and convert to posixct date time
tempdata$time = as.POSIXct(paste(tempdata$dd.mm.yyyy, tempdata$hh.mm, sep = " "), tz = "SAST", format = "%d/%m/%Y %H:%M")
```

# Ele to tower

```{r ele_to_tower}
#'get tower loc
towerloc = tempdata[1,c("long","lat")]

#'load spatial libs
library(sp); library(rgdal); library(proj4); library(geosphere)

#'find dist from ele to tower
ele2$dist.tow = distVincentyEllipsoid(p1 = towerloc, p2 = ele2[,c("long","lat")])
```

# Eles within 10km

```{r eles_near_tower}
#'keep only eles within 10km of the tower

quantile(ele2$dist.tow, 0.01)

ele.tow = ele2 %>% filter(dist.tow <= 1e4)
```

```{r match_temp_ele.tow}
#'match half hourly temp to the eles
#'first round the ele time to the half hour
ele.tow = ele.tow %>% 
  mutate(roundtime = round_date(ele.tow$time, "30 minute"))

#'merge by time and round time
ele.tow = left_join(ele.tow, tempdata, by = c("roundtime" = "time"))
#'rename X.C
ele.tow = ele.tow %>% rename(temp.a = X.C)
tempdata = tempdata %>% rename(temp.a = X.C)

#'set all vals less than 0 to NA
ele.tow = ele.tow %>% mutate(temp.a = ifelse(temp.a < 0, NA, temp.a))
tempdata = tempdata %>% mutate(temp.a = ifelse(temp.a < 0, NA, temp.a))

#'add season to tempdata
tempdata = inner_join(tempdata, ele.tow[,c("roundtime","season2")], by = c("time" = "roundtime"))
```

# Plot temp_a and temp

```{r body_amb_temp_prep}
#'plot elephant body and ambient temp
ele.tow02 = ele2 %>% group_by(hour = hour(time),season2) %>% 
  summarise(meantemp = mean(temp), n = length(temp), sd = sd(temp)) %>% 
  mutate(t.ci = qnorm(0.975)*sd/sqrt(n))

towtemp = tempdata %>% group_by(hour = hour(time), season2) %>% 
  summarise(meantempa = mean(temp.a, na.rm= T), n.ta = length(temp.a), sd.ta = sd(temp.a, na.rm = T)) %>% 
  mutate(ta.ci = qnorm(0.975)*sd.ta/sqrt(n.ta))
```


```{r}
save(ele.tow, ele.tow02, towtemp, fig_temp_measure_hour, file = "/home/pratik/git/elephants/ele_data/ele.tower.rdata")
```


# Correlogram for hourly mean temps from eles ~ tower

```{r temp_matrix}
#'correlation between columns of x and y
#'set data and column names for eledata dry season

ele.tow03.dry = ele.tow %>% 
  filter(dist.tow <=1e4, season2 == "dry") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp) %>%  
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp, fill = NA) %>% 
  select(-ind)

#'set data for the wet season
ele.tow03.wet = ele.tow %>% 
  filter(dist.tow <=1e4, season2 == "wet") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp) %>%  
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp, fill = NA) %>% 
  select(-ind)

#'set colnames
colnames(ele.tow03.dry) = c(paste("ele", 1:24, sep="_"))
colnames(ele.tow03.wet) = c(paste("ele", 1:24, sep="_"))

#'set columns for the tower data for the dry season
towtemp03.dry = ele.tow %>% 
  filter(dist.tow<=1e4, season2 == "dry") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp.a) %>% 
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp.a, fill = NA) %>% 
  select(-ind)

#'for the wet season
towtemp03.wet = ele.tow %>% 
  filter(dist.tow<=1e4, season2 == "wet") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp.a) %>% 
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp.a, fill = NA) %>% 
  select(-ind)

#'set colnames
colnames(towtemp03.dry) = c(paste("amb", 1:24, sep="_"))
colnames(towtemp03.wet) = c(paste("amb", 1:24, sep="_"))
```

```{r corrs}
#'for each hour by col, store corr and p val as df per season
#'cool dry
corrs.dry = list()
#'do cor.test instead of cor
for(i in 1:24){
  corrs.dry[[i]] = (cor.test(x = as.data.frame(towtemp03.dry)[,i], y = as.data.frame(ele.tow03.dry)[,i]))[c("p.value","estimate")] %>% bind_cols()
}
#'get df with bound rows
corrs.dry = corrs.dry %>% bind_rows() %>% mutate(hour = 0:23, season = "cool")

#'for hot wet
corrs.wet = list()
#'do cor.test instead of cor
for(i in 1:24){
  corrs.wet[[i]] = (cor.test(x = as.data.frame(towtemp03.wet)[,i], y = as.data.frame(ele.tow03.wet)[,i]))[c("p.value","estimate")] %>% bind_cols()
}
#'get df with bound rows
corrs.wet = corrs.wet %>% bind_rows() %>% mutate(hour = 0:23, season = "hot")
```

## plot

```{r}
#'correlation by season by hour, filtered by p val

#pdf(file = "time.temp.corr.pdf", height = 5, width = 5)

bind_rows(corrs.dry, corrs.wet) %>%
  ggplot()+
  geom_point(aes(x = hour, y = estimate, shape = season, size = 1/p.value, fill = season))+
 # geom_path(aes(x = hour, y = estimate, shape = season), width = 0.2)+
  scale_shape_manual(values = c(21,24))+
  #scale_colour_manual(values = c(cola3, colb3))+
  labs(list(x = "Hour of day", y = "Temperature correlation (Pearson's r)"))

```


```{r custom_pval_matrix_func}
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
```

```{r}
#'LM for thermochron temperature ~ ambient temp
temp.model = lm(temp ~ temp.a + season2, data = ele.tow)

#'get model results
summary(temp.model)
```

# Plot hourly temp

```{r}

#### make figure of temps per hour of day
load("/home/pratik/git/elephants/ele_data/ele.tower.rdata")

fig_temp_measure_hour <- 
ggplot()+
    
    geom_rangeframe(data = data_frame(x = c(0,23), y=c(15,40)), aes(x,y))+
  
    geom_path(data = ele.tow02, aes(x = hour, y = meantemp, ymin = meantemp-t.ci, ymax = meantemp+t.ci, col = season2), lty = 1, position = position_dodge(width = 0.5), lty = 1, size = 0.6)+

  geom_path(data = towtemp, aes(x = hour, y = meantempa, ymin = meantempa-ta.ci, ymax = meantempa+ta.ci, col = season2), lty=2, position = position_dodge(width = 0.5), lty = 1, size = 0.7)+
  
  geom_ribbon(data = ele.tow02, aes(x = hour, ymin = meantemp-t.ci, ymax = meantemp+t.ci, group = season2, fill = season2), alpha = 0.2)+

  geom_ribbon(data = towtemp, aes(x = hour, ymin = meantempa-ta.ci, ymax = meantempa+ta.ci, group = season2, fill = season2), alpha = 0.2)+

  
  scale_colour_brewer(palette = "Set1")+
  scale_fill_brewer(palette = "Set1")+
  #scale_shape_manual(values = c(21,24))+
  coord_cartesian(xlim = c(0,23))+
  scale_x_continuous(breaks = c(0,4,8,12,16,20,23))+
  scale_y_continuous(breaks = seq(15,40,5))+
  theme_pub()+
  labs(list(x = "Hour of day", y = "Temperature (°C)", title = "(a)"))

```


# Scatterplot

```{r scatterplot}
#'plot scatterplot

#### to be replaced by a bland altman plot?


fig_temp_rel_data <- ele.tow %>% #filter(dist.tow <= 1e4) %>% 
  group_by(season2, temp.a = round(temp.a)) %>%
  summarise(mt = mean(temp, na.rm = T), sd.mt = sd(temp, na.rm = T), n.mt = length(temp)) %>% 
  mutate(mt.ci = qnorm(0.975)*sd.mt/sqrt(n.mt)) 
  
fig_temp_measure_relation <- 
ggplot()+
 # geom_smooth(aes(x = temp.a, y = mt, group = season2, lty = season2, col = season2), method = "glm", show_guide = F, lwd = 0.5,se =F, fill = "grey90")+
  geom_segment(aes(x = 5, xend = 40, y = 5, yend = 40),size = 0.3)+
  
  geom_pointrange(data = fig_temp_rel_data, aes(x = temp.a, y = mt, ymin = mt-mt.ci, ymax = mt+mt.ci,shape = season2,  col = season2), position = position_dodge(width = 0.5), lty = 1, fill = "white", size = 0.3)+
  
  
  geom_rangeframe(data = data_frame(x = c(5,40), y = c(4,44)), aes(x,y))+

  scale_colour_brewer(palette = "Set1")+
  scale_shape_manual(values = c(21, 24))+
  scale_x_continuous(breaks = seq(5,40,5))+
  scale_y_continuous(breaks = seq(4,44,4))+
  #scale_linetype_manual(values = c(2,1))+
  theme_pub()+
  coord_cartesian(xlim=c(5,40), ylim = c(5,44))+
  #coord_cartesian(xlim = c(0,40), ylim = c(0,40))+
  labs(list(x = "Ambient temperature (°C)", y = "Collar temperature (°C)", title = "(b)"))

#ggsave(filename = "fig01_b.png", fig01_b, device = png())
```

## bland altman plot

```{r}
#'for each time point, gather the temp amb in col 1, and the thermochron temps in cols 2, 3...n. use the mean at each timepoint as the reading from dev 2, where the amb temp is dev 1. construct the BA plot using blandr.
#'then, for the data, run a GAMM with id and landscape type as a mixed effect. follow the procedure here http://derekogle.com/fishR/2017-04-20-Modified_BlandAltmanPlot to produce a better plot.

#'load data
load("/home/pratik/git/elephants/ele_data/ele.tower.rdata")

#'get the data
ele.ba.test <- ele.tow %>% select(season2, id, time, temp, temp.a) %>% 
  filter(!is.na(temp.a)) %>% 
  group_by(time, temp.a, season2) %>% 
  summarise(mean.ele.temp = mean(temp, na.rm = T))
  
#'use the blandr package BA test
library(blandr)

blandr.display.and.draw(method1 = ele.ba.test$mean.ele.temp, method2 = ele.ba.test$temp.a)
```

```{r}
#'difference vs mean GAM

ele.ba.test <- ele.ba.test %>%
  mutate(mean = (temp.a+mean.ele.temp)/2, diff = mean.ele.temp - temp.a)

library(mgcv)
ele.ba.gam <- gam(diff ~ s(mean, k = 3), data = ele.ba.test)

#'get the predicted differences
pred <- predict(ele.ba.gam, type = "response", se = T, newdata = ele.ba.test)

pred.fit <- as.vector(pred$fit); pred.se <- as.vector(pred$se.fit)

#'add to the df
ele.ba.test <- ungroup(ele.ba.test)
ele.ba.test <- ele.ba.test %>% 
  ungroup() %>% 
  mutate(pred = pred.fit,
         ci = 1.96*pred.se)
```

```{r}
#'make a BA plot
#'frontiers figure sizes in inches
full = 180/25.4; half = 85/25.4
#'make a better plot
fig_temp_bland_altman <- 
ggplot()+
  geom_segment(aes(x = 10, xend = 40, y = 0, yend =0), lty = 2, col = 1, size = 0.3)+
  
  geom_segment(aes(x = c(10), xend = c(40), y = c(13.38, -2.2, 5.672,13.77, -1.805, 5.902), yend = c(13.38, -2.2, 5.672,13.77, -1.805, 5.902)), lty = 3, col = brewer.pal(3,"Dark2")[rep(c(1,2,3),2)], size = 0.3)+
  
  geom_segment(aes(x = c(10), xend = c(40), y = c(13.6, -2, 5.9), yend = c(13.6, -2, 5.9)), lty = 1, col = brewer.pal(3,"Dark2")[rep(c(1,2,3),1)], size = 0.3)+
  
 # geom_hline(yintercept = c(13.577, -2.00, 5.787), lty = 2, col = 1, size = 0.2)+
  
  geom_point(data = ele.ba.test, aes(x = (mean), y = diff), alpha = 0.2, size = 0.3, col = "grey50", shape = 20)+
  
  geom_smooth(data = ele.ba.test, aes(x = mean, y = pred), col = 2, size = 0.5,se=F)+
  
  geom_smooth(data = ele.ba.test, aes(x = mean, y = pred-ci), col = 2, lty = 2, size = 0.5,se=F)+
  
  geom_smooth(data = ele.ba.test, aes(x = mean, y = pred+ci), col = 2, lty = 2, size = 0.5, se=F)+
  
  #geom_text(aes(x = 40, y = c(15, 5, -4), label = c("LoA ± 95% CI","Mean diff. ± 95% CI","LoA ± 95% CI")), hjust = "inward", fontface = "italic", size = 2)+
  
  geom_rangeframe(data = data_frame(x = c(10,40), y = c(-5,15)), aes(x,y))+
  
  scale_shape_manual(values = c(17,19))+
  scale_colour_brewer(palette = "Dark2")+
  
  theme_pub()+
  #theme_tufte()+
  labs(list(x = "Mean of measures (°C)", y = "Difference of measures", title = "(c)"))+
  xlim(5,40)+
  scale_x_continuous(breaks = seq(10,40,10))+ scale_y_continuous(breaks=c(-5,5,15))+
  coord_cartesian(xlim = c(10,40), ylim = c(-5,15))

#ggsave(filename = "fig_temp_bland_altman_plot.png", plot = fig_temp_bland_altman, device = png(), width = half, height = half, dpi = 300);dev.off()
```

```{r}
#'export fig for temp measures
library(gridExtra)

pdf(file = "figs/fig03temp_measures.pdf",height = half, width = full)
#png(filename = "fig_thermochron_data.png",height = 1600, width = 3200, res = 400)

grid.arrange(fig_temp_measure_hour, fig_temp_measure_relation, fig_temp_bland_altman, nrow = 1)

dev.off()
```

