
# Load libs
  
```{r load_libs, message=FALSE, warning=FALSE}
#set env
source("libs.R")
```

```{r load_data}
#'source script
load("eledata.rdata")
source('ggplot.pub.r')

ele2 = ele %>% as.data.frame() %>% filter(temp %in% 14:40)
```

```{r load_tempdata}
#'load the skukuza flux tower temp data
tempdata = read.csv("~/git/elephants/ele_data/skukuza_tower_temp.csv")

#'handle time and convert to posixct date time
tempdata$time = as.POSIXct(paste(tempdata$dd.mm.yyyy, tempdata$hh.mm, sep = " "), tz = "SAST", format = "%d/%m/%Y %H:%M")
```

# Ele to tower

```{r ele_to_tower}
#'get tower loc
towerloc = tempdata[1,c("long","lat")]

#'load spatial libs
library(sp); library(rgdal); library(proj4); library(geosphere)

#'find dist from ele to tower
ele2$dist.tow = distVincentyEllipsoid(p1 = towerloc, p2 = ele2[,c("long","lat")])

#'check ditr of dists
#hist(ele$dist.tow)
```

# Eles within 10km

```{r eles_near_tower}
#'keep only eles within 10km of the tower

quantile(ele2$dist.tow, 0.01)

ele.tow = ele2 %>% filter(dist.tow < 1e4)
```

```{r match_temp_ele.tow}
#'match half hourly temp to the eles
#'first round the ele time to the half hour
ele.tow = ele.tow %>% 
  mutate(roundtime = round_date(ele.tow$time, "30 minute"))

#'merge by time and round time
ele.tow = left_join(ele.tow, tempdata, by = c("roundtime" = "time"))
#'rename X.C
ele.tow = ele.tow %>% rename(temp.a = X.C)
tempdata = tempdata %>% rename(temp.a = X.C)

#'set all vals less than 0 to NA
ele.tow = ele.tow %>% mutate(temp.a = ifelse(temp.a < 0, NA, temp.a))
tempdata = tempdata %>% mutate(temp.a = ifelse(temp.a < 0, NA, temp.a))

#'add season to tempdata
tempdata = inner_join(tempdata, ele.tow[,c("roundtime","season2")], by = c("time" = "roundtime"))
```

# Plot temp_a and temp

```{r body_amb_temp_prep}
#'plot elephant body and ambient temp
ele.tow02 = ele2 %>% group_by(hour = hour(time),season2) %>% 
  summarise(meantemp = mean(temp), n = length(temp), sd = sd(temp)) %>% 
  mutate(t.ci = qnorm(0.975)*sd/sqrt(n))

towtemp = tempdata %>% group_by(hour = hour(time), season2) %>% 
  summarise(meantempa = mean(temp.a, na.rm= T), n.ta = length(temp.a), sd.ta = sd(temp.a, na.rm = T)) %>% 
  mutate(ta.ci = qnorm(0.975)*sd.ta/sqrt(n.ta))
```

# Plot hourly temp

```{r}

####

fig01_a <- 
ggplot()+
  geom_pointrange(data = ele.tow02, aes(x = hour, y = meantemp, ymin = meantemp-t.ci, ymax = meantemp+t.ci, shape = season2,col = season2, fill = season2), shape = 21, position = position_dodge(width = 0.5), lty = 1,size = 0.3)+

  geom_pointrange(data = towtemp, aes(x = hour, y = meantempa, ymin = meantempa-ta.ci, ymax = meantempa+ta.ci,shape = season2, fill = season2, col = season2), shape = 24, position = position_dodge(width = 0.5), lty = 1,size = 0.3)+

  scale_colour_manual(values = pubcols)+
  scale_fill_manual(values = c("white","grey20"))+
  #scale_shape_manual(values = c(21,24))+
  theme_pub()+
  labs(list(x = "Hour of day", y = "Ambient temperature (°C)", title = "(a)"))

```

# Correlogram for hourly mean temps from eles ~ tower

```{r temp_matrix}
#'correlation between columns of x and y
#'set data and column names for eledata dry season

ele.tow03.dry = ele.tow %>% 
  filter(dist.tow <=1e4, season2 == "dry") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp) %>%  
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp, fill = NA) %>% 
  select(-ind)

#'set data for the wet season
ele.tow03.wet = ele.tow %>% 
  filter(dist.tow <=1e4, season2 == "wet") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp) %>%  
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp, fill = NA) %>% 
  select(-ind)

#'set colnames
colnames(ele.tow03.dry) = c(paste("ele", 1:24, sep="_"))
colnames(ele.tow03.wet) = c(paste("ele", 1:24, sep="_"))

#'set columns for the tower data for the dry season
towtemp03.dry = ele.tow %>% 
  filter(dist.tow<=1e4, season2 == "dry") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp.a) %>% 
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp.a, fill = NA) %>% 
  select(-ind)

#'for the wet season
towtemp03.wet = ele.tow %>% 
  filter(dist.tow<=1e4, season2 == "wet") %>% 
  mutate(hour = as.factor(hour(time))) %>% 
  select(hour, temp.a) %>% 
  group_by(hour) %>% 
  mutate(ind = row_number()) %>% 
  spread(hour, temp.a, fill = NA) %>% 
  select(-ind)

#'set colnames
colnames(towtemp03.dry) = c(paste("amb", 1:24, sep="_"))
colnames(towtemp03.wet) = c(paste("amb", 1:24, sep="_"))
```

```{r corrs}
#'for each hour by col, store corr and p val as df per season
#'cool dry
corrs.dry = list()
#'do cor.test instead of cor
for(i in 1:24){
  corrs.dry[[i]] = (cor.test(x = as.data.frame(towtemp03.dry)[,i], y = as.data.frame(ele.tow03.dry)[,i]))[c("p.value","estimate")] %>% bind_cols()
}
#'get df with bound rows
corrs.dry = corrs.dry %>% bind_rows() %>% mutate(hour = 0:23, season = "cool")

#'for hot wet
corrs.wet = list()
#'do cor.test instead of cor
for(i in 1:24){
  corrs.wet[[i]] = (cor.test(x = as.data.frame(towtemp03.wet)[,i], y = as.data.frame(ele.tow03.wet)[,i]))[c("p.value","estimate")] %>% bind_cols()
}
#'get df with bound rows
corrs.wet = corrs.wet %>% bind_rows() %>% mutate(hour = 0:23, season = "hot")
```

## plot

```{r}
#'correlation by season by hour, filtered by p val

#pdf(file = "time.temp.corr.pdf", height = 5, width = 5)

bind_rows(corrs.dry, corrs.wet) %>%
  ggplot()+
  geom_point(aes(x = hour, y = estimate, shape = season, size = 1/p.value, fill = season))+
 # geom_path(aes(x = hour, y = estimate, shape = season), width = 0.2)+
  scale_shape_manual(values = c(21,24))+
  #scale_colour_manual(values = c(cola3, colb3))+
  labs(list(x = "Hour of day", y = "Temperature correlation (Pearson's r)"))

```


```{r custom_pval_matrix_func}
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
```

```{r}
#'LM for thermochron temperature ~ ambient temp
temp.model = lm(temp ~ temp.a + season2, data = ele.tow)

#'get model results
summary(temp.model)
```


# Scatterplot

```{r scatterplot}
#'plot scatterplot

fig01_b <- 
  ele.tow %>% filter(dist.tow <= 1e4) %>% 
  group_by(season2, temp.a = round(temp.a)) %>%
  summarise(mt = mean(temp, na.rm = T), sd.mt = sd(temp, na.rm = T), n.mt = length(temp)) %>% 
  mutate(mt.ci = qnorm(0.975)*sd.mt/sqrt(n.mt)) %>% 
  
  ggplot()+
  geom_smooth(aes(x = temp.a, y = mt, group = season2, lty = season2, col = season2), method = "glm", show_guide = F, lwd = 0.5,se =F, fill = "grey90")+
  
  geom_pointrange(aes(x = temp.a, y = mt, ymin = mt-mt.ci, ymax = mt+mt.ci,shape = season2,  col = season2), position = position_dodge(width = 0.5), lty = 1, fill = "white", size = 0.3)+

  scale_colour_manual(values = pubcols)+
  #scale_fill_manual(values= c(cola2, colb2))+
  scale_shape_manual(values = c(21, 24))+
  scale_linetype_manual(values = c(2,1))+
  theme_pub()+
  labs(list(x = "Ambient temperature (°C)", y = "Elephant temperature (°C)", title = "(b)"))

```

# Fig01

## colour
```{r fig01_col}
cairo_pdf(filename = "figs/fig05temp_loggers.colour.pdf",height = 85/25.4, width = 180/25.4, fallback_resolution = 600)
library(gridExtra)
#png(filename = "fig_thermochron_data.png",height = 1600, width = 3200, res = 400)

grid.arrange(fig01_a, fig01_b, nrow = 1)

dev.off()
```
