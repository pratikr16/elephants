---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
source("libs.R")
source("ggplot.pub.r")
```

```{r}
#'load revisits data
load("ele.revisits.rdata")
#'load 24 hour loop data 
load("loop24hrdata.rdata")
```


# coeff. var. speed ~ temp

```{r}
load("ele.mod.speed.RData")
## Fig 3a. Speed ~ temp
#'
ele.speed.temp = 
ele.rev %>% #filter(!id %in% problem_eles) %>%
  mutate(v.pred = predict(mod.speed, newdata = ., scale = "response", allow.new.levels = T), temp = round_any(temp,2)) %>%  group_by(season2, temp) %>% 
  summarise(v.mean = mean(v), v.sd = sd(v), cv.v = v.sd*1e2/v.mean, n.v = length(v), pred.mean = mean(v.pred, na.rm = T), pred.sd=sd(v.pred, na.rm = T), pred.n = length(v.pred)) %>%
  mutate(v.ci = qnorm(0.975)*v.sd/sqrt(n.v), ci.pred = qnorm(0.975)*pred.sd/sqrt(pred.n))
```

## cv speed temp

```{r}
#'coefficient of variation of speed with temp
png(filename = "cv.speed.temp.png", height = 1600, width = 1600, res = 400)

ele.speed.temp %>% filter(temp %in% 15:40) %>% 
  ggplot()+
  #vegm_smooth(aes(x = temp, y = pred.mean*2, col = season2, fill = season2), lty = 1, lwd = 0.5)+
 # vegm_ribbon(aes(x = temp, ymin = pred.mean-ci.pred, ymax = pred.mean+ci.pred, fill = season2), alpha = 0.5)+
  vegm_point(aes(x = temp, y = cv.v, col = season2, shape = season2),fill = "white", size = 3)+
  scale_colour_manual(values = c(cola,colb))+
  scale_fill_manual(values = c(cola1,colb1))+
  scale_shape_manual(values=c(21,24))+
  theme_bw()+g1+
  labs(list(x = "Temperature (Â°C)", y = "Coeff. var. speed",
            col = "Season", fill = "Season"))

dev.off()
```

# temp and mindw ~ landscape type

```{r}
#'load soil data
library(sf)
veg = st_read("~/git/elephants/ele_data/gis_etc/Kruger Updated GIS Layers/landscapes_gertenbach1983.shp")
#'use rev data
#'convert to sf
ele.sf = st_as_sf(ele.rev, coords = c("xutm","yutm"), crs = 32736)
#'extract polygon values
ele.sf$veg = sp::over(as(ele.sf, "Spatial"), as(veg, "Spatial"))$LANDSCAPE
```

## sample landsat
```{r}
#'read in points
landsat.samples = st_read("spatial/landsat_sampling_pts.shp")
```


```{r}
library(raster)
#'load temp raster layer
landsat.temp = raster::raster("~/git/elephants/ele_data/landsat7_temp_kruger.tif")

#'load water raster
#waterraster = raster("waterraster.tif")

#'sample landsat temps at ele.sf points
ele.sf$landsat_temp = raster::extract(landsat.temp, ele.sf)


#landsat.samples$l7_temp = extract(landsat.temp, landsat.samples)
#landsat.samples$mindw = extract(waterraster, landsat.samples)

#landsat.samples$veg = sp::over(as(landsat.samples, "Spatial"), as(veg, "Spatial"))$LANDSCAPE

#landsat.samples = as.data.frame(landsat.samples) %>% dplyr::select(veg, l7_temp, mindw) %>% mutate(mindw = mindw/1e3) %>% melt(id.vars = "veg") %>% filter(!is.na(veg))

```

```{r}
#pdf(filename = "waterdistance.temp.vegclass.pdf", height = 6, width = 10)
#'make plot
vegclass.vars = as.data.frame(ele.sf) %>% filter(hour %in% 8:17) %>% dplyr::select(veg, temp, landsat_temp) %>% melt(id.vars = "veg") %>% filter(!is.na(veg)) 

#vegclass.vars = bind_rows(vegclass.vars, landsat.samples)

vegclass.vars$veg = droplevels(vegclass.vars$veg)

vegclass.vars$veg = factor(vegclass.vars$veg, levels=rev(levels(vegclass.vars$veg)))
  
a = data_frame(num = unique(as.character(as.numeric(vegclass.vars$veg))), y = -2, variable = "mindw", veg = (unique(vegclass.vars$veg))) %>% arrange(veg)

b = count(vegclass.vars, veg)

a = left_join(a, b, by = c("veg" = "veg"))
  
veg1 = ggplot(data = vegclass.vars)+
  
  geom_hline(data = vegclass.vars %>% group_by(variable) %>% summarise(mean = mean(value, na.rm=T)), aes(yintercept = mean),col = 2, lty = 2)+
  
  geom_boxplot(aes(x = (as.numeric(veg)), group = (as.numeric(veg)), y = value), outlier.size = 0.1, notch = F, width = 0.6, position = "dodge")+
  
  facet_wrap(~ifelse(variable == "temp", "Thermochron temp.", 
                     ifelse(variable == "mindw", "Dist. to water (km)", "LANDSAT-7 temp.")), scales = "free_x")+
  theme_pub()+
  coord_flip()+
  scale_x_continuous(trans = "reverse", labels = a$num, breaks = c(1:dim(a)[1]))+
  theme(axis.ticks.y = element_blank(),# axis.text.y = element_blank(),
        strip.text = element_text(size = 10, face = "plain"))+
  labs(list(x = "Landscape type", y = NULL))
```

```{r}

veg2  = 
ggplot(a)+
  geom_text(aes(x = 1, y = c(1:dim(a)[1]), label = (a$veg)),
            hjust = "left", size = 3)+
  geom_text(aes(x = 1.82, y = c(1:dim(a)[1]), label = paste("(", (a$n), ")", sep = ""), fontface = "italic"),
            hjust = "outward", size = 3)+
  coord_cartesian(xlim = c(1,2))+
  theme_pub()+
#  scale_y_continuous()+
  scale_y_reverse(breaks = (c(1:dim(a)[1])), labels = (as.character(c(1:dim(a)[1]))))+
  theme(axis.line = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank(), axis.text.x = element_blank(), plot.title = element_text(face = "plain"))+
  labs(list(y = NULL, title = "Vegetation types & sample size"))
```

```{r}
library(gridExtra)
pdf(file = "mindw.temp.vegclass.pdf", height = 5, width = 11)
grid.arrange(veg1, veg2, ncol = 2, layout_matrix = rbind(c(1,1,1,1,2,2,2,2), c(1,1,1,1,2,2,2,2)))

dev.off()
```

# Models: thermochron temperature as a function of landsat temp and vegclass

## get data

```{r}

#'prep data
ele = ele.sf; st_geometry(ele) = NULL; ele = ele %>% dplyr::select(temp, veg, id, hour, season2, landsat_temp) %>% mutate(id = as.factor(id)) %>% filter(hour %in% 6:18)
```

## run model

```{r}
library(lme4)
#'thermochron daily temps and vegetation class
mod.temp.veg = glmer(temp ~ sqrt(landsat_temp) + veg*sqrt(hour) + season2 + (1|id), data = ele, family = "poisson")
```

# ANOVA landsat temp ~ vegclass

```{r}
#'run a glm
glm.temp.veg = glm(round(landsat_temp) ~ veg, data = ele, family = "poisson")

summary(glm.temp.veg)
```

