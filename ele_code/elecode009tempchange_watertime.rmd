---
  editor_options:
    chunk_output_type: console
  chunk_output_type: console
---
# Temp fates of incoming eles

# Load libs

```{r load_libs, message=FALSE, warning=FALSE}
#set env
library(plyr);library(dplyr);library(purrr);library(purrrlyr);library(data.table);library(lubridate);library(tidyr)

library(ggplot2)
```

```{r ggplot_theme}
source("ggplot.opts.r")
```

```{r get_data}
source("ele.code002.5dataloading.r")
```


# Split and arrange, get waterdiff and tempdiff

```{r temp_change}
library(zoo)
#'rate of tempchange as a relation to distance to water of points

ele02 = ele %>% dlply("id") %>%
  map(function(x) plyr::arrange(x, time) %>% mutate(tempdiff = c(NA, diff(temp, lag = 1)), waterdiff = c(diff(distw, lag = 1), NA))) %>% bind_rows()
```

# Filter data
Filter data to include only:
1. Incoming eles, waterdiff > -500:+500
2. Distwater <= 500
3. All points satisfying both above, and the next 10 points.

```{r temp_fates_data}
#'work on the split ele02 as etf1, ie, ele temp fates 1

#'split into list of 13
etf1 = ele02 %>% dlply("id") %>% map(function(x) mutate(x, arrival = ifelse(waterdiff < 0 & distw <=500, "arrival", "other")))

#'split each df into a list by the arrival event
etf2 = etf1 %>% map(function(x) x %>% dlply("arrival"))

#'find the timediff in the arrival events df
for(i in 1:13){
  x = etf2[[i]]$arrival
  etf2[[i]]$arrival$timediff = c(NA, difftime(x$time[-1], x$time[-dim(x)[1]], units = "hours"))
  etf2[[i]]$arrival = etf2[[i]]$arrival %>% filter(timediff > 5)
}

#'bind rows
etf3 = etf2 %>% map(rbind_list) %>% map(function(x) arrange(x, time))
```

```{r id_consecutive_points}
#'find the next 10 points at each arrival event
for(i in 1:13){
  a = which(etf3[[i]]$arrival == "arrival")
  etf3[[i]] = etf3[[i]][unique(sort(a + rep(0:10, each = length(a)))),]
  etf3[[i]] = etf3[[i]] %>% filter(distw < 500)
}

etf3 = etf3 %>% map(function(x) x = x %>% mutate(event = cumsum(arrival == "arrival")))

#etf3 = etf3 %>% map(function(x) x = x %>% dlply("event") %>% map(function(y) y = mutate(y, watertime = difftime(time, time[1]))))
```

```{r water_time_tempchange}
#'bind the lists
etf4 = etf3 %>% map(function(x) x = x %>% group_by(event) %>% mutate(watertime = difftime(time, time[1], units = "hours"), tempchange = temp - temp[1]))

etf4 = bind_rows(etf4) %>% filter(watertime <=8)

etf4 = as.data.frame(etf4)
```

# Run model

```{r run_glmm_tempchange_watertime}
#'run a glmm
library(lme4)
mod.tempchange = lmer(tempchange ~ watertime + distw + season2 + (1|id), data = etf4)

summary(mod.tempchange)
```

# Fig 8. Temp change with time at water

```{r tempchange_watertime}
#'get data

etf.fig = etf4 %>% 
  mutate(pred = predict(mod.tempchange, newdata = etf4, allow.new.levels = T, scale = "response")) %>% 
  group_by(watertime = round_any(as.numeric(watertime), 0.5), season2) %>% 
  summarise(deltat.mean = mean(tempchange, na.rm = T), deltat.sd = sd(tempchange, na.rm = T), deltat.n = length(tempchange), predmean = mean(pred, na.rm = T), predsd = sd(pred, na.rm = T), predn = length(pred)) %>% 
  
mutate(deltat.ci = qnorm(0.975)*deltat.sd/sqrt(deltat.n), pred.ci = qnorm(0.975)*predsd/sqrt(predn))
```

```{r fig8.tempchange.watertime}
#'plot fig 8
#pdf(file = "fig8tempchange_watertime.pdf", height = 4, width = 4)

#png(filename = "fig8tempchange_watertime.png", height = 1600, width = 1600, res = 500)

cairo_pdf(filename = "fig5deltat.watertime.pdf", height = 4, width = 4, fallback_resolution = 600)

etf.fig %>% 
  ggplot()+
  geom_smooth(aes(x = watertime, y = predmean, col = season2, fill = season2), lwd = 0.5)+
  geom_hline(yintercept = 0, lty = 2, col = 1)+
  geom_pointrange(aes(x = watertime, y = deltat.mean, ymin = deltat.mean-deltat.ci, ymax = deltat.mean+deltat.ci, col = season2, shape = season2), fill = "white", fatten = 10, stroke = 0.8, lty = 1, lwd = 0.2, position = position_dodge(width = 0.3))+
  scale_colour_manual(values = c(cola,colb))+
  scale_fill_manual(values = c(cola1,colb1))+
  scale_shape_manual(values = c(21, 24))+
  theme_bw()+g1+
  labs(list(x = "Time since arrival at water (hrs)", y = "Δ Temperature °C"))+
  xlim(0,5)+ylim(-1.75,NA)

dev.off()
```

