
# identifying loops

```{r}
source("libs.R")
source("ggplot.opts.r")
source("ggplot.pub.r")
```

```{r}
load("ele.revisits.rdata")
load("eledata.rdata")

ele.rev = left_join(ele.rev, ele2)

```

# find high rev and low distance to water

```{r}
#'quantiles
quantile(ele.rev$angle, na.rm = T)

ele.rev$watervisits = ifelse(ele.rev$mindw <=500 & ele.rev$fpt < 3 & ele.rev$residence >=10 & ele.rev$revisits >= 10, 
1, 0)

#ggplot(ele.rev)+ geom_smooth(aes(x = mindw, y = residence/revisits))+
  #coord_cartesian(xlim = c(0,5e2), ylim = c(1.5,1.65))

#a = ele.rev %>% filter(watervisits == 1, !is.na(waterdiff)) %>% select(id, xutm, yutm, v, angle, mindw, revisits, residence, fpt, waterdiff)

#write.csv(a, file = "ele.watervisits.csv", row.names = F)
```

# find water visits by each ele

```{r}
#'separate by ele, and find the time between consecutive watervisits

ele3 = ele.rev %>% dlply("id") %>%
  map(function(x) x %>% filter(watervisits == 1))

#'here, use diff rather than difftime, adding NA for the first point, and getting the output in numeric hours
for(i in 1:14){
  ele3[[i]]$wvint = c(NA, as.numeric(diff(ele3[[i]]$time)/60))
}

ele3 = bind_rows(ele3)

```

# plot time between water visits

```{r}
#'remove bad difftimes.
#### don't filter just yet####
ele4 = ele3 #%>% filter(wvint > 3, wvint < 72)
```

## Prep interval distribution

```{r interval_distr}

#'plot to see dist of revisit rates
#fig2b = 
ggplot()+
  stat_density(data = ele3 %>% filter(wvint > 3, wvint < 72),aes(x = wvint, col = season2), position = "identity",geom = "line", lwd = 0.7)+
  geom_rect(aes(xmin = 12, xmax = 24, ymin = 0.0, ymax = 0.035), col = "grey20", lwd = 0.2, fill = "transparent")+
 scale_colour_manual(values = c(cola, colb))+
  #facet_wrap(~ifelse(season2 == "dry", "Cool dry", "Hot wet"))+
  theme_pub()+
  labs(list(x = "Water visit interval (hrs)", title = "(b)"))
```

# Distance between track start and end

```{r}
#'remove points where the water visit interval is less than 3, these are points where the elephant is loitering near water. these are water visit points

#### dont' filter just yet ####

#ele4 = ele3 %>% filter(wvint > 3, wvint < 72)

#'select all points which are not water visits
ele.rev2 = anti_join(ele.rev, ele4, by = c("id", "time"))

#'assign a watervisit identifier of 0, or false, and a watervisit interval of NA
ele.rev2$watervisits = 0; ele.rev2$wvint = NA

#'recombine the non-visit and visit points, it should be the same size as the base data, here, 278757
ele5 = rbind(ele.rev2, ele4)

#'sort the recombined data by id and time
ele5 = ele5 %>% arrange(id, time)
```

## identifying and numbering segments between water

```{r}
#'split by elephant and identify the segments between water
ele5  = ele5 %>% dlply("id") %>%
  map(function(x){
    x %>% mutate(loop = cumsum(watervisits))
  })

#'for each elephant and each segment, find
#'1. the time difference between the ith point of the segment and the start
#'2. the change in distance to water from the start point
#'3. the change in temperature since the start
#'4. the instantaneous change in temperature
#'5. the proportion of the segment completed at each point
ele6 =  ele5 %>%
  map(function(x){
    x %>% group_by(loop) %>% mutate(looptime = as.numeric(difftime(time, time[1], units = "hours")), deltadw = mindw - mindw[1], tempchange = temp - temp[1], ambtempdiff = c(NA, diff(temp))) %>% #filter(looptime < 24) %>% 
      mutate(loopprop = looptime/max(looptime))
  })

#'now find the displacement between the first and last point
library(sp)
ele6 = ele6 %>% bind_rows()

#'get the first and last x-y coords, the season, the time taken for the loop to be completed, the mean speed, the temperature at the halfway point, the mean temperature along the loop, the instantaneous change in temp at the halfway stage
ele7 = ele6 %>% group_by(id, loop) %>% 
  summarise(x1 = first(xutm), y1 = first(yutm), x2 = last(xutm), y2 = last(yutm), season = first(season2), looptime = max(looptime, na.rm = T), v = mean(v, na.rm = T), t50 = temp[first(which(round_any(loopprop, 0.05) == 0.5))], temp = mean(temp, na.rm=T), tdiff50 = ambtempdiff[first(which(round_any(loopprop, 0.05) == 0.5))], wvint = first(wvint), distance = sum(distance, na.rm=T), maxdw = max(mindw,na.rm = T), hour_start = first(hour), hour_50 = hour[first(which(round_any(loopprop, 0.05) == 0.5))], hour_end = last(hour), mdw_start = first(mindw), mdw_end = last(mindw))

ele.all.loops = ele7

#'remove loops with a looptime above 72
ele7 = ele7 %>% filter(looptime <=72, looptime > 3)

#'split by each loop
ele7 = ele7 %>% dlply(c("id","loop"))

#'now find distances between first and last points of the loop
for(i in 1:length(ele7)){
  a = ele7[[i]]
  ele7[[i]]$between_point_dist = (spDists(x = as.matrix(a[c("x1","y1")]), y = as.matrix(a[c("x2","y2")])))
}

#'bind rows and get histogram
ele7 = rbind_list(ele7)

#'count the number of loops where the displacement was under 500m

count(ele7, between_point_dist<=500, season)
```

```{r}
#pdf(file = "duration.density.pdf", width = 4,height = 4)
ggplot()+
  stat_density(data = ele7, aes(x = looptime, col = season), position = "identity",geom = "line", lwd = 0.7)+
  geom_rect(aes(xmin = 12, xmax = 24, ymin = 0.0, ymax = 0.045), col = "grey20", lwd = 0.2, fill = "transparent")+
 scale_colour_manual(values = c(cola, colb))+
  #facet_wrap(~ifelse(season2 == "dry", "Cool dry", "Hot wet"))+
  theme_pub()+
  labs(list(x = "Segment duration (hrs)"))

#dev.off()
```

## distance along segment

```{r}
describe(ele7$distance)
```


## displacement and movement variables

### duration and displacement

```{r}
#'export
#png(filename = "displacement.looptime.png", res = 300, height = 1600, width = 1600)

ele7 %>% mutate(dur = cut(looptime, c(3,12,24,48,72))) %>%
  ggplot(aes(x = looptime, y = between_point_dist/1e3, col = season))+
  geom_smooth(size = 1)+
# facet_wrap(~dur, scales = "free")+
  theme_pub()+theme(strip.text = element_text(colour = 1))+
  scale_color_manual(values = c(cola, colb))+
  labs(list(x = "Duration, track b/w water points (hrs)", y = "Displacement b/w water points"))#+
  #coord_cartesian(xlim = c(3,24))

#dev.off()
```


### t50 and displacement

```{r}
#'what's the displacement in relation to temperature halfway through the track?

ele7 %>% 
 # mutate(dur = cut(looptime, seq(0,72, 12)), tround = round_any(temp, 5)) %>% filter(!is.na(dur)) %>%
 # group_by(dur, tround, season) %>% 
 # summarise(mean = mean(between_point_dist/1e3), sd = sd(between_point_dist/1e3)) %>% 
  
  ggplot()+
 # geom_pointrange(aes(x = tround, y = mean, ymin = mean-sd, ymax=mean+sd, shape = season), col = 1, lwd = 0.5, position = position_dodge(width = 5), fill = "white")+
  geom_smooth(aes(x = t50, y = between_point_dist/1e3, col = season))+
  #scale_shape_manual(values = c(21,24))+
  #coord_cartesian(ylim=c(0,2))+
  theme_pub()+
  scale_color_manual(values = c(cola,colb))+
  xlim(14,40)
 # facet_wrap(~dur, scales = "free")
```

## displacement density plot

```{r ele_looping}
#pdf(file = "deisplacement.density.pdf", height = 4, width = 4)
#fig2a = 
ggplot(ele7)+
  stat_density(aes(x = between_point_dist/1e3, col = season), geom = "line", position = "identity", lwd =1)+
  scale_colour_manual(values = c(cola, colb))+
  theme_pub()+
  labs(list(x = "Displacement (km)"))+
  xlim(0,5)

#dev.off()
```


# Ele loops


```{r}
library(sp)

#'split by id and season

ele.lines = ele6 %>% inner_join(ele7, by = c("id","loop")) %>% bind_rows() %>% arrange(id, time) %>%  dlply(c("id","loop")) %>%
  map(function(x) Line(cbind(x$xutm, x$yutm)))

ele.lines = ele.lines %>%
  map(function(x) Lines(x, ID = "a"))

for(i in 1:length(ele.lines)){
  ele.lines[[i]]@ID = names(ele.lines)[i]
}

names = names(ele.lines)

ele.lines = SpatialLines(ele.lines, proj4string = CRS("+proj=utm +zone=36 +south +datum=WGS84 +units=m +no_defs"))

library(stringi)

data = data.frame(cbind(id = 1:length(ele.lines), name = names, ele = stri_extract(names, regex='[^.]*'), loop = as.numeric(sub('.*\\.', '', names))))

data$loop = as.numeric(as.character(data$loop))

rownames(data) = names

ele.lines = SpatialLinesDataFrame(ele.lines, data = data)

#'export
library(rgdal)
writeOGR(ele.lines, dsn = "loops", layer = "ele.loops.all_crit", driver = "ESRI Shapefile", overwrite_layer = T)
```

# Begin processing for 24 hour tracks

```{r}
#'get the day loops
dayloops = ele7 %>% filter(looptime > 12, looptime<24)

#'now get only the loop and id data associated with these loops from ele6, which is all points

dayloopdata = ele7 %>% filter(looptime > 12, looptime<24) %>% select(id, loop) %>% left_join(ele6, by = c("id", "loop"))
```


## whats's happening in loops?

```{r}
#'loop data summary
dayloopdata = dayloopdata %>%
  #bind_rows() %>%
  #filter(looptime < 24, looptime > 12) %>%
  select(loopprop, mindw, waterdiff, temp, fpt, loop, season2, v, tempchange, woody.density, hour, ambtempdiff)
```

## plots

### stage and time of day

```{r}
#'use viridis throughout? no, red blue is understood by more people
#'purple is cool dry,green is hot wet
library(viridis)
#fig loop1 time ~ prop
#figS4 =
  dayloopdata %>%
    group_by(season2, loopprop = as.factor(round_any(loopprop, 0.1))) %>%
    #summarise(meanhour = mean(hour)) %>%
  ggplot()+
    theme_pub()+

#  geom_smooth(aes(x = loopprop, y = hour, col = season2, fill = season2), lty = 1, se = T, lwd = 0.5)+
 # geom_violin(aes(x = loopprop, y = hour), fill = "grey90", col = "transparent", position = position_dodge(width = 0.95))+
    geom_boxplot(aes(x = loopprop, y = hour, fill = season2, col = season2), position = position_dodge(width = 0.95), lwd = 0.3, notch = F, outlier.size = 0.2, outlier.colour = 1, outlier.shape = 21)+
    
  scale_color_manual(values = c(cola, colb))+
  scale_fill_manual(values = c(cola2, colb2))+
  scale_x_discrete(breaks = seq(0,1,0.5), labels = c("Start", "50%", "End"))+
    labs(list(x = "Track stage", y = "Hour of day"))
```

## start, end, 50% plots

```{r}
seg_time = ele7 %>% 
  group_by(loop, season) %>% 
  melt(measure.vars =c("hour_50","hour_end","hour_start"))
  
pdf(file="fig.seg_time.pdf", width = 4, height = 4)
ggplot()+
  stat_density(data = seg_time, aes(x = value, col = variable), position = "identity",geom = "line", lwd = 1)+
  scale_colour_manual(values = c(cola2, colb2, colc))+
  labs(list(x = "Hour of day", y = "Density"))+
  theme_pub()

dev.off()

```


## prep data for ci plots

```{r}
dayloopsum = dayloopdata %>% 
  group_by(season2, loopprop = round_any(loopprop, 0.1)) %>% 
  select(loopprop, season2, mindw, temp, v, woody.density) %>% 
  melt(id.vars = c("loopprop","season2")) %>% 
  group_by(loopprop, season2, variable) %>% 
  summarise(mean = mean(value, na.rm = T), sd = sd(value, na.rm = T), n = length(value)) %>% 
  mutate(ci = qnorm(0.975)*sd/sqrt(n))
```

### plot all vars at once

```{r}
#'plot all
dayloopsum %>% filter(variable != "woody.density")

plotter = ggplot()+
  geom_pointrange(aes(x = loopprop, y = mean, ymin = mean-ci, ymax = mean+ci,  col = season2, shape = season2, fill = season2), lty = 1, lwd = 0.5, fatten = 5, stroke = 0.6, position = position_dodge(width = 0.1))+
  scale_color_manual(values = c(cola, colb))+
   scale_fill_manual(values = c(cola2, colb2))+
  scale_shape_manual(values = c(21,24))+
    labs(list(x = "Track stage", y = "Value"))+
  scale_x_continuous(breaks = seq(0,1,0.5), labels = c("Start", paste(50,"%", sep=""), "End"))+
  #facet_wrap(~variable, scales = "free")+
  theme_pub()
```

### Fig 2(c) Distance to water vs track stage

```{r mindw_loop}

fig_seg2 = dayloopsum %>% filter(variable ==  "temp") %>% 

ggplot()+
  geom_pointrange(aes(x = loopprop, y = mean, ymin = mean-ci, ymax = mean+ci,  col = season2, shape = season2, fill = season2), lty = 1, lwd = 0.5, fatten = 5, stroke = 0.6, position = position_dodge(width = 0.1))+
  scale_color_manual(values = c(cola, colb))+
   scale_fill_manual(values = c(cola2, colb2))+
  scale_shape_manual(values = c(21,24))+
    labs(list(x = "Track stage", y = "Temperature (°C)", title = "(b)"))+
  scale_x_continuous(breaks = seq(0,1,0.5), labels = c("Start", paste(50,"%", sep=""), "End"))+
  #facet_wrap(~variable, scales = "free")+
  theme_pub()
```

### Fig 2(e) Speed vs track stage

```{r}
fig_seg3 = dayloopsum %>% filter(variable ==  "v") %>% 

ggplot()+
  geom_pointrange(aes(x = loopprop, y = mean*2, ymin = (mean-ci)*2, ymax = (mean+ci)*2,  col = season2, shape = season2, fill = season2), lty = 1, lwd = 0.5, fatten = 5, stroke = 0.6, position = position_dodge(width = 0.1))+
  scale_color_manual(values = c(cola, colb))+
   scale_fill_manual(values = c(cola2, colb2))+
  scale_shape_manual(values = c(21,24))+
    labs(list(x = "Track stage", y = "Speed (m/hr)", title = "(c)"))+
  scale_x_continuous(breaks = seq(0,1,0.5), labels = c("Start", paste(50,"%", sep=""), "End"))+
  #facet_wrap(~variable, scales = "free")+
  theme_pub()
```

## mindw and stage

```{r}
fig_seg1 = dayloopsum %>% filter(variable ==  "mindw") %>% 

ggplot()+
  geom_pointrange(aes(x = loopprop, y = mean, ymin = mean-ci, ymax = mean+ci,  col = season2, shape = season2, fill = season2), lty = 1, lwd = 0.5, fatten = 5, stroke = 0.6, position = position_dodge(width = 0.1))+
  scale_color_manual(values = c(cola, colb))+
   scale_fill_manual(values = c(cola2, colb2))+
  scale_shape_manual(values = c(21,24))+
    labs(list(x = "Track stage", y = "Distance to water (m)", title = "(a)"))+
  scale_x_continuous(breaks = seq(0,1,0.5), labels = c("Start", paste(50,"%", sep=""), "End"))+
  #facet_wrap(~variable, scales = "free")+
  theme_pub()
```

## export segment figures

```{r}
pdf(file = "fig_seg_vars.pdf", height = 4, width=8)
library(patchwork)

fig_seg1+fig_seg2+fig_seg3

dev.off()
```


```{r}

#figloop_woods = 
  dayloopdata %>%
    #group_by(season2, loopprop = as.factor(round_any(loopprop, 0.1))) %>%
   # summarise(meanhour = mean(hour)) %>%
  ggplot()+

 geom_smooth(aes(x = loopprop, y = woody.density, col = season2, fill = season2), lty = 1, se = T, lwd = 0.5)
   # geom_violin(aes(x = loopprop, y = woody.density), fill = "grey90", col = "transparent", position = position_dodge(width = 0.95))+
   # geom_boxplot(aes(x = loopprop, y = woody.density, col = season2, fill = season2), position = position_dodge(width = 0.95), lwd = 0.3, notch = F, outlier.size = 0.2, outlier.colour = 1, outlier.shape = 21)+
  scale_color_manual(values = c(cola, colb))+
    scale_fill_manual(values = alpha(c(cola, colb),0.2))+
  scale_x_discrete(breaks = seq(0,1,0.2), labels = c("Start", paste(seq(20,80,20),"%", sep=""), "End"))+
    labs(list(x = "Loop stage", y = "Woody density"))+
  g1
```



# Load speed mod

```{r}
load("ele.mod.speed.RData")
## Fig 3a. Speed ~ temp
#'
ele.speed.temp = ele2 %>% #filter(!id %in% problem_eles) %>%
  mutate(v.pred = predict(mod.speed, newdata = ., scale = "response", allow.new.levels = T), temp = round_any(temp,2)) %>%  group_by(season2, temp) %>%
  summarise(v.mean = mean(v), v.sd = sd(v), n.v = length(v), pred.mean = mean(v.pred, na.rm = T), pred.sd=sd(v.pred, na.rm = T), pred.n = length(v.pred)) %>%
  mutate(v.ci = qnorm(0.975)*v.sd/sqrt(n.v), ci.pred = qnorm(0.975)*pred.sd/sqrt(pred.n))
```

---

# model speeds

## for loop data

```{r}
#'run cyclic gam
library(mgcv)
dayloopdata$id = as.factor(dayloopdata$id)
mod.speed.loop = bam(v ~ s(temp, k = 4, bs = "cc") + season2 + woody.density + s(id, bs = "re"), data = dayloopdata %>% filter(temp %in% 14:40))

ele.speed.temp.loop = dayloopdata %>% #filter(!id %in% problem_eles) %>%
  mutate(v.pred = predict(mod.speed, newdata = ., scale = "response", allow.new.levels = T), temp = round_any(temp,2)) %>%  group_by(season2, temp) %>%
  summarise(v.mean = mean(v), v.sd = sd(v), n.v = length(v), pred.mean = mean(v.pred, na.rm = T), pred.sd=sd(v.pred, na.rm = T), pred.n = length(v.pred)) %>%
  mutate(v.ci = qnorm(0.975)*v.sd/sqrt(n.v), ci.pred = qnorm(0.975)*pred.sd/sqrt(pred.n))
```

## speed temp plot loop data

```{r}
pdf(file = "fig4.2speed.loops.pdf", height = 4, width=4)
#'plot begins here

#fig2f = 
  ele.speed.temp.loop %>% filter(temp %in% 15:40) %>% 
  ggplot()+
  geom_smooth(aes(x = temp, y = pred.mean*2, col = season2, fill = season2), lty = 1, lwd = 1)+
 # geom_ribbon(aes(x = temp, ymin = pred.mean-ci.pred, ymax = pred.mean+ci.pred, fill = season2), alpha = 0.5)+
  geom_pointrange(aes(x = temp, y = v.mean*2, ymin = (v.mean-v.ci)*2, ymax = (v.mean+v.ci)*2, col = season2, shape = season2, fill = season2), fatten = 7, lty = 1, stroke = 0.6, position = position_dodge(width = 1))+
  scale_colour_manual(values = c(cola2,colb2))+
  scale_fill_manual(values = c(cola1,colb1))+
  scale_shape_manual(values=c(21,24))+
  theme_pub()+
  labs(list(x = "Temperature (°C)", y = "Speed (m/hour)",
            col = "Season", fill = "Season"))

dev.off()
```


## prepare speed~temp plot all data

```{r plot_speed_temp}
pdf(file = "fig4speed.pdf", height = 4, width=4)
#'plot begins here

#fig2f = 
  ele.speed.temp %>% filter(temp %in% 15:40) %>% 
  ggplot()+
  geom_smooth(aes(x = temp, y = pred.mean*2, col = season2, fill = season2), lty = 1, lwd = 1)+
 # geom_ribbon(aes(x = temp, ymin = pred.mean-ci.pred, ymax = pred.mean+ci.pred, fill = season2), alpha = 0.5)+
  geom_pointrange(aes(x = temp, y = v.mean*2, ymin = (v.mean-v.ci)*2, ymax = (v.mean+v.ci)*2, col = season2, shape = season2, fill = season2), fatten = 7, lty = 1, stroke = 0.6)+
  scale_colour_manual(values = c(cola2,colb2))+
  scale_fill_manual(values = c(cola1,colb1))+
  scale_shape_manual(values=c(21,24))+
  theme_pub()+
  labs(list(x = "Temperature (°C)", y = "Speed (m/hour)",
            col = "Season", fill = "Season"))

dev.off()
```


