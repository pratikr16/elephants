---
editor_options:
  chunk_output_type: console
---

# Speed and heading

# Load libs

```{r load_libs, message=FALSE, warning=FALSE}
#set env
source("libs.R")
```

```{r}
load("ele_with_dem.rdata")
source("ggplot.opts.r")
```

## Model: Speed ~ temp

```{r model}
library(mgcv)
ele.sf$id = as.factor(ele.sf$id)
mod.speed = bam(v ~ s(temp, k = 4) + season2 + woody.density + s(id, bs = "re") + slope, data = ele.sf %>% filter(temp %in% 14:40))
```

## Fig 3a. Speed ~ temp

```{r ele.speed.temp.data}
#'
ele.speed.temp = ele.sf %>% #filter(!id %in% problem_eles) %>%
  mutate(v.pred = predict(mod.speed, newdata = ., scale = "response", allow.new.levels = T), temp = round_any(temp,2)) %>%  group_by(season2, temp) %>%
  summarise(v.mean = mean(v), v.sd = sd(v), n.v = length(v), pred.mean = mean(v.pred, na.rm = T), pred.sd=sd(v.pred, na.rm = T), pred.n = length(v.pred)) %>%
  mutate(v.ci = qnorm(0.975)*v.sd/sqrt(n.v), ci.pred = qnorm(0.975)*pred.sd/sqrt(pred.n))
```


```{r}
pdf(file = "fig4.2speed.loops.pdf", height = 4, width=4)
#'plot begins here

fig09 =
  ele.speed.temp %>% filter(temp %in% 15:40) %>%
  ggplot()+
  geom_smooth(aes(x = temp, y = pred.mean*2, col = season2, fill = season2), lty = 1, lwd = 1)+
 # geom_ribbon(aes(x = temp, ymin = pred.mean-ci.pred, ymax = pred.mean+ci.pred, fill = season2), alpha = 0.5)+
 
  geom_pointrange(aes(x = temp, y = v.mean*2, ymin = (v.mean-v.ci)*2, ymax = (v.mean+v.ci)*2, col = season2, shape = season2), fill = "white", lty = 1, lwd = 0.5, position = position_dodge(width = 1))+

  scale_colour_manual(values = c(cola,colb))+
  scale_fill_manual(values = c(cola1,colb1))+
  scale_shape_manual(values=c(21,24))+
  theme_pub()+
  labs(list(x = "Temperature (Â°C)", y = "Speed (m/hour)",
            col = "Season", fill = "Season"))

dev.off()
```


# Speed ~ hour
```{r}
ele.speed.time = ele2 %>% mutate(v.pred = predict(mod.speed, newdata = ., scale = "response", allow.new.levels = T)) %>%  group_by(season2, hour) %>%
  summarise(v.mean = mean(v), v.sd = sd(v), n.v = length(v), pred.mean = mean(v.pred, na.rm = T), pred.sd=sd(v.pred, na.rm = T), pred.n = length(v.pred)) %>%
  mutate(v.ci = qnorm(0.975)*v.sd/sqrt(n.v), ci.pred = qnorm(0.975)*pred.sd/sqrt(pred.n))
```

```{r}
fig4bspeed_time =
  ggplot()+
  geom_hline(yintercept = seq(250, 750, 250), lty = 1, col="grey")+
  geom_text(inherit.aes = F, aes(x = 23.5, y = seq(250, 750, 250), label = c("250m/hr","500m/hr","750m/hr")), vjust = "outward", size = 2)+

  geom_vline(xintercept = 23.5, lty = 2, col = 1, lwd = 0.2)+
 # geom_smooth(aes(x =hour, y = pred.mean*2, col = season2, fill = season2), lty = 1, lwd = 0.5)+
 # geom_ribbon(aes(x = temp, ymin = pred.mean-ci.pred, ymax = pred.mean+ci.pred, fill = season2), alpha = 0.5)+
  geom_bar(data= ele.speed.time, aes(x = hour, y = v.mean*2, fill = season2), stat = "identity", position = "dodge")+
  #scale_colour_manual(values = c(cola,colb))+
  scale_fill_manual(values = c(cola1,colb))+
  scale_shape_manual(values=c(21,24))+
  theme_bw()+g1+
  coord_polar(start = 2*pi)+
  ylim(-250,NA)+
  scale_x_continuous(breaks = seq(0,24,1))+
 theme(axis.ticks.y = element_blank(), axis.text.y = element_blank())+
  labs(list(title = "B", x = NULL, y = NULL))
```

# Relative heading ~ temperature

# Fig.3

```{r export}

cairo_pdf(filename = "figs/fig09_speed_temp.pdf", height = 85/25.4, width = 85/25.4)

fig09

dev.off()
```

# save data for plotting

```{r}
save(mod.speed, fig2f, ele.speed.temp, file = "ele.mod.speed.RData")
```
