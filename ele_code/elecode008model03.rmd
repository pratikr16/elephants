---
editor_options: 
  chunk_output_type: console
---
  
# Load libs
  
```{r load_libs, message=FALSE, warning=FALSE}
#set env
library(plyr);library(dplyr);library(purrr);library(purrrlyr);library(data.table);library(lubridate);library(tidyr)

library(ggplot2)

#'use visreg
library(visreg)
```

```{r load_data}
#'source script
source("ele.code002.5dataloading.r")

#'source publication theme
source("ggplot_pub.r")
```

```{r mod.speed}
#'glmm
ele$v = round(ele$v)
ele = ele %>% filter(v>0, round(temp) %in% 15:40)
ele = ele %>% mutate(towater = ifelse(waterd))

#'run a bam
library(mgcv)

mod.speed = bam(v ~ s(distw, by = season2,bs = "cr")+
                        s(temp, by = season2, bs = "cr")+
                        ti(distw, temp, by = season2, bs = "cr")+
                        woody.density+
                        s(id, bs = "re") + s(season, bs = "re"),
                        data = ele)
```

```{r pass_visreg_temp}
vis.speed.temp = visreg(mod.speed, xvar = "temp", scale = "response", plot = F, by = "season2")

out.speed.temp = vis.speed.temp$fit
```

```{r pass_to_visreg_distw}
vis.speed.distw = visreg(mod.speed, "distw", scale = "response", plot = F, by = "season2")

out.speed.distw = vis.speed.distw$fit
```

# Fig 04

```{r ele.speed.temp}
#'
ele.speed.temp = ele %>% filter(v > 0, round(temp) %in% 15:40) %>% mutate(tempclass = round_any(temp, 1)) %>% group_by(season2, tempclass) %>%
  summarise(v.mean = mean(v), v.sd = sd(v), n.v = length(v)) %>%
  mutate(v.ci = qnorm(0.975)*v.sd/sqrt(n.v))
```

```{r plot_speed_temp}
png(file = "fig04speed_temp.png", width = 1600, height = 1600, res = 300)

#'plot begins here
ele.speed.temp %>% 
  ggplot()+
  
  geom_line(data = out.speed.temp, aes(x = temp, y = visregFit, col = season2), lty = 2)+
  geom_ribbon(data = out.speed.temp, aes(x = temp, ymin = visregLwr, ymax = visregUpr,fill = season2))+
  geom_point(aes(x = tempclass, y = v.mean, col = season2), size = 2)+
  geom_linerange(aes(x = tempclass, ymin = v.mean-v.ci, ymax = v.mean+v.ci, col = season2), lty = 3)+
  scale_colour_manual(values = c("royalblue", "indianred1"),
                      labels = c("Cool", "Hot"))+
  scale_fill_manual(values = c("lightblue", "lightpink"),
                      labels = c("Cool", "Hot"))+
  theme_Publication()+
  theme(legend.position = c(0.1, 0.85),
        legend.background = element_rect(#fill="lightblue",
                                  size=0.5, linetype="solid"))+
  labs(list(x = "Temperature (Â°C)", y = "Speed (m/30 minutes)",
            col = "Season", fill = "Season"))

dev.off()
```

# Fig 05

```{r ele.speed.distw}
ele.speed.distw = ele %>% group_by(season2, distw_round = round_any(distw, 100)/1e3) %>%
  summarise(v.mean = mean(v), v.n = length(v), sd = sd(v), mean.pred.v = mean(pred.v, na.rm = T)) %>%
  mutate(v.ci = qnorm(0.975)*sd/sqrt(v.n))
```


```{r plot.speed.distw}
png(file = "fig05speed_distw.png", res = 300, width = 1600, height = 1600)

ele.speed.distw %>% 
  
  ggplot()+
  
  geom_line(data = out.speed.distw, aes(x = distw/1e3, y = visregFit, col = season2), lty = 2)+
geom_ribbon(data = out.speed.distw, aes(x = distw/1e3, ymin = visregLwr, ymax = visregUpr, fill = season2), alpha = 0.4)+
 #geom_line(aes(x = distw_round, y = mean.pred.v, col = season2), lty = 2)+
  
  geom_point(aes(x = distw_round, y = v.mean, col = season2), size = 2)+
  geom_linerange(aes(x = distw_round, ymin = v.mean-v.ci, ymax = v.mean+v.ci, col = season2), lty = 3, lwd = 0.3)+
  scale_colour_manual(values = c("royalblue", "indianred1"),
                                 labels = c("Cool","Hot"))+
  
  scale_fill_manual(values = c("lightblue", "lightpink"),
                                 labels = c("Cool","Hot"))+
  theme_Publication()+
  theme(legend.position = c(0.8, 0.85),
        legend.background = element_rect(#fill="lightblue",
                                  size=0.5, linetype="solid"))+
  xlim(0, 5) + ylim(160, 240)+
  labs(list(x = "Distance to nearest water-source (km)", y = "Steplength (m/30 minutes)", col = "Season", fill = "Season"))

dev.off()
```