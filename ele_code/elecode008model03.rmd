---
editor_options:
  chunk_output_type: console
---

# Speed and heading

# Load libs

```{r load_libs, message=FALSE, warning=FALSE}
#set env
source("libs.R")
```

```{r}
source("elecode2.6dataloading.r")
source("ggplot.opts.r")
```

## Model: Speed ~ temp

```{r model}
library(mgcv)

mod.speed = bam(v ~ s(mindw, by = season2) + s(temp, by = season2, k = 4) + season2 + woody.density + s(id, bs = "re"), data = ele2)
```

## Fig 3a. Speed ~ temp

```{r ele.speed.temp.data}
#'
ele.speed.temp = ele2 %>% mutate(v.pred = predict(mod.speed, newdata = ., scale = "response", allow.new.levels = T), temp = round_any(temp,2)) %>%  group_by(season2, temp) %>%
  summarise(v.mean = mean(v), v.sd = sd(v), n.v = length(v), pred.mean = mean(v.pred, na.rm = T), pred.sd=sd(v.pred, na.rm = T), pred.n = length(v.pred)) %>%
  mutate(v.ci = qnorm(0.975)*v.sd/sqrt(n.v), ci.pred = qnorm(0.975)*pred.sd/sqrt(pred.n))
```


```{r plot_speed_temp}
pdf(file = "fig_speed_temp.pdf", height = 4, width=4)
#'plot begins here

fig4aspeed_temp = 
  ele.speed.temp %>%
  ggplot()+
  geom_smooth(aes(x = temp, y = pred.mean*2, col = season2, fill = season2), lty = 1, lwd = 0.5)+
 # geom_ribbon(aes(x = temp, ymin = pred.mean-ci.pred, ymax = pred.mean+ci.pred, fill = season2), alpha = 0.5)+
  geom_pointrange(aes(x = temp, y = v.mean*2, ymin = (v.mean-v.ci)*2, ymax = (v.mean+v.ci)*2, col = season2, shape = season2), fatten = 10, fill = "white", lty = 1, lwd = 0.2, stroke = 0.6)+
  scale_colour_manual(values = c(cola,colb))+
  scale_fill_manual(values = c(cola1,colb1))+
  scale_shape_manual(values=c(21,24))+
  theme_bw()+g1+
  labs(list(x = "Temperature (°C)", y = "Speed (m/hour)",
            col = "Season", fill = "Season", title = "A"))

dev.off()
```

# Speed ~ hour
```{r}
ele.speed.time = ele2 %>% mutate(v.pred = predict(mod.speed, newdata = ., scale = "response", allow.new.levels = T)) %>%  group_by(season2, hour) %>%
  summarise(v.mean = mean(v), v.sd = sd(v), n.v = length(v), pred.mean = mean(v.pred, na.rm = T), pred.sd=sd(v.pred, na.rm = T), pred.n = length(v.pred)) %>%
  mutate(v.ci = qnorm(0.975)*v.sd/sqrt(n.v), ci.pred = qnorm(0.975)*pred.sd/sqrt(pred.n))
```

```{r}
fig4bspeed_time = 
  ggplot()+
  geom_hline(yintercept = seq(250, 750, 250), lty = 1, col="grey")+
  geom_text(inherit.aes = F, aes(x = 23.5, y = seq(250, 750, 250), label = c("250m/hr","500m/hr","750m/hr")), vjust = "outward", size = 2)+
  
  geom_vline(xintercept = 23.5, lty = 2, col = 1, lwd = 0.2)+
 # geom_smooth(aes(x =hour, y = pred.mean*2, col = season2, fill = season2), lty = 1, lwd = 0.5)+
 # geom_ribbon(aes(x = temp, ymin = pred.mean-ci.pred, ymax = pred.mean+ci.pred, fill = season2), alpha = 0.5)+
  geom_bar(data= ele.speed.time, aes(x = hour, y = v.mean*2, fill = season2), stat = "identity", position = "dodge")+
  #scale_colour_manual(values = c(cola,colb))+
  scale_fill_manual(values = c(cola1,colb))+
  scale_shape_manual(values=c(21,24))+
  theme_bw()+g1+
  coord_polar(start = 2*pi)+
  ylim(-250,NA)+
  scale_x_continuous(breaks = seq(0,24,1))+
 theme(axis.ticks.y = element_blank(), axis.text.y = element_blank())+
  labs(list(title = "B", x = NULL, y = NULL))
```

# export speed figs

```{r}
library(gridExtra)

cairo_pdf(filename = "fig4speed_plots.pdf", height = 4, width = 8, fallback_resolution = 600)
grid.arrange(fig4aspeed_temp, fig4bspeed_time, nrow = 1)
dev.off()
```


# Relative heading ~ temperature

Filter out only moving animals,ie, those who have moved 100m or more in each fix.
Easiest way to do this is to convert to a move object.

```{r move_obj}
#'make move, arrange by id, and time
ele2 = ele %>% plyr::arrange(id, time)

library(move)

ele.move = ele.move = move(x = ele2$xutm, y = ele2$yutm, 
                  time = ele2$time, animal = ele2$id,
                  proj = CRS("+proj=utm +zone=36 +south +datum=WGS84 +units=m +no_defs"), data = ele2)
```

```{r get_stats}
#'get distance, timediff, speed
ele.move = split(ele.move)

for(i in 1:length(ele.move)){
  ele.move[[i]]$lag = c(NA, timeLag(ele.move[[i]]))
  ele.move[[i]]$distance = c(NA, distance(ele.move[[i]]))
  ele.move[[i]]$speed = c(NA,speed(ele.move[[i]]))
}

#'make a list of dfs and bind
ele2 = lapply(ele.move, as.data.frame)
ele2 = bind_rows(ele2)
```

## Filter moving animals

```{r filter moving animals}
#'moving animals, ie, distance covered over 100m, bad timelags, less than 10mins or over 60mins
ele2 = ele2 %>% filter(lag %in% 20:60)
#ele2 = ele2 %>% filter(distance > 100)

ele2$id = ele2$from.idData.rep.1..n.locs.from.....
```

# Fig. 3b. Waterdiff ~ temp

```{r waterdiff~temp}

fig3b = 
  ele2 %>% filter(v > 100) %>% 
  group_by(temp, season2) %>%
  summarise(mean.waterdiff = mean(waterdiff), sd.wd = sd(waterdiff), n.wd = length(waterdiff)) %>%
  mutate(wd.ci = qnorm(0.975)*sd.wd/sqrt(n.wd)) %>% 

  ggplot()+

  geom_hline(aes(yintercept = 0), col = "grey20", lty = 2, lwd = 0.5)+

    geom_pointrange(aes(x = temp, y = mean.waterdiff, ymin = mean.waterdiff-wd.ci, ymax = mean.waterdiff+wd.ci, col = season2, shape = season2), position = position_dodge(width = 0.7), fatten = 10, lty = 1, fill = "white", stroke = 0.7, lwd = 0.2)+
  scale_colour_manual(values = c(cola,colb))+
  scale_shape_manual(values = c(21, 24))+
  theme_bw()+g1+
   # facet_wrap(~distwclass, scales = "free")+
  labs(list(x = "Temperature (°C)", y = "Δ Distance to water (m)", fill = "Season", shape = "Season", colour = "Season"))#+ylim(-25,30)+xlim(15,40)

```

# Fig.3

```{r export}

library(gridExtra)

cairo_pdf(filename = "fig3.pdf", height = 4, width = 8)
grid.arrange(fig3a, nrow = 1)

dev.off()
```

